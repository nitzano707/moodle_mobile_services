<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>מכללת תלפיות - שליפת מידע מהמוודל</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#0b4d88;--accent:#0d63b5;--accent2:#0b58a4;--light:#f5f7fb;--card:#ffffff;--muted:#6b7280;--line:#e5e7eb}
    body{margin:0;background:var(--light);color:#1f2937;font-family:"Segoe UI","Rubik",Tahoma,Arial,sans-serif}
    header{background:var(--blue);color:#fff;padding:22px 16px}
    header .wrap{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{margin:0;font-size:22px}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tabbtn{border:1px solid #d4dbe6;background:#e8eef6;color:#0b2743;padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer}
    .tabbtn.active{background:#fff}
    .danger{background:#ffe8e8;color:#7a0d0d;border-color:#ffd1d1}
    .container{max-width:1200px;margin:auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
    .pillbar{display:flex;flex-wrap:wrap;gap:10px}
    .pill{border:1px solid #dbe3ed;background:#eef2f7;padding:9px 13px;border-radius:999px;cursor:pointer;font-weight:600}
    .pill.selected{background:var(--accent);color:#fff}
    .crumbs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .crumb{background:#f1f5fb;border:1px solid #dbe3ed;border-radius:999px;padding:6px 10px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:6px 12px;cursor:pointer}
    .btn:hover{background:var(--accent2)}
    .btn.secondary{background:#eef3f9;color:#0b2743;border:1px solid #d4dbe6}
    table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:right;vertical-align:top}
    th{background:#f0f4f8}
    .files a{display:block;margin:2px 0;text-decoration:underline}
    .ok{padding:10px;background:#e9f9f2;border:1px solid #c7f0df;border-radius:10px;color:#0a7f48;margin-top:10px}
    .error{padding:10px;background:#ffecec;border:1px solid #ffc9c9;border-radius:10px;color:#7a0d0d;margin-top:10px}
    .grade-input{width:70px}
    .fb-input{width:100%;min-width:200px}
    footer{text-align:center;color:#555;padding:15px;border-top:1px solid #ddd;margin-top:20px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>מכללת תלפיות - שליפת מידע מהמוודל</h1>
      <div class="top-actions">
        <button id="navHier" class="tabbtn active" onclick="showTab('hierarchy')">ממשק היררכי 📚</button>
        <button id="navFuncs" class="tabbtn" onclick="showTab('functions')">פונקציות זמינות ⚙️</button>
        <button class="tabbtn danger" onclick="deleteToken()">מחק Token 🗑️</button>
      </div>
    </div>
  </header>

  <div class="container">

    <!-- Login -->
    <div id="loginScreen" class="card">
      <h2>התחברות עם Token</h2>
      <input type="password" id="tokenInput" placeholder="הדבק כאן את ה-Token" style="width:60%">
      <button class="btn" onclick="saveToken()">שמור</button>
    </div>

    <!-- Main -->
    <div id="mainScreen" class="hidden">
      <div id="crumbsBox" class="card hidden">
        <div class="crumbs">
          <div id="crumbYear" class="crumb hidden"></div>
          <div id="crumbSem" class="crumb hidden"></div>
          <div id="crumbCourse" class="crumb hidden"></div>
          <div id="crumbAssign" class="crumb hidden"></div>
          <button class="btn secondary" onclick="resetSelections()">נקה בחירות</button>
        </div>
      </div>

      <div id="hierarchyTab">
        <div id="years" class="card">
          <h3>שנות לימוד</h3>
          <div id="yearsBar" class="pillbar"></div>
        </div>
        <div id="semesters" class="card hidden">
          <h3>סמסטרים</h3>
          <div id="semsBar" class="pillbar"></div>
        </div>
        <div id="courses" class="card hidden">
          <h3>קורסים</h3>
          <div id="coursesBar" class="pillbar"></div>
        </div>
        <div id="assignments" class="card hidden">
          <h3>מטלות</h3>
          <div id="assignList"></div>
        </div>
        <div id="submissions" class="card hidden">
          <h3 id="subsTitle">הגשות</h3>
          <div id="subsArea"></div>
          <div id="subsMsg" class="ok hidden"></div>
          <div id="subsErr" class="error hidden"></div>
        </div>
      </div>

      <div id="functionsTab" class="hidden">
        <div class="card">
          <h3>כל הפונקציות בטוקן</h3>
          <div id="funcsBar" class="pillbar"></div>
          <pre id="funcResult" style="white-space:pre-wrap;overflow:auto;max-height:400px"></pre>
        </div>
      </div>
    </div>

    <footer>פותח ע"י ד"ר ניצן אליקים | סביבת Vibe Coding</footer>
  </div>

<script>
const baseUrl="https://moodle4.talpiot.ac.il";
let token=localStorage.getItem("moodleToken")||"";
const state={me:null,courses:[],selectedYear:null,selectedSem:null,selectedCourse:null,enrolled:new Map(),assignId:null,assignName:""};

window.onload=()=>{if(token)init();};

function saveToken(){token=document.getElementById("tokenInput").value.trim();if(!token)return;localStorage.setItem("moodleToken",token);init();}
function deleteToken(){localStorage.removeItem("moodleToken");location.reload();}
function showTab(t){document.getElementById("hierarchyTab").classList.toggle("hidden",t!=="hierarchy");document.getElementById("functionsTab").classList.toggle("hidden",t!=="functions");}

async function apiCall(wsfunction,params={}){const q=new URLSearchParams({wstoken:token,wsfunction,moodlewsrestformat:"json"});for(const[k,v]of Object.entries(params))q.append(k,v);const res=await fetch(`${baseUrl}/webservice/rest/server.php?${q}`);const d=await res.json();if(d.exception||d.errorcode)throw new Error(d.message);return d;}
const fmtDate=ts=>ts?new Date(ts*1000).toLocaleString():"–";
const fmtGrade=g=>(g==null||g==="")?"–":parseInt(g);

async function init(){
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("mainScreen").classList.remove("hidden");
  state.me=await apiCall("core_webservice_get_site_info");
  state.courses=await apiCall("core_enrol_get_users_courses",{userid:state.me.userid});
  renderYears();buildFunctions();
}
function buildFunctions(){const funcs=state.me.functions||[];const bar=document.getElementById("funcsBar");bar.innerHTML="";funcs.forEach(f=>{const b=document.createElement("button");b.className="pill";b.textContent=f.name;b.onclick=async()=>{document.getElementById("funcResult").textContent="טוען...";try{const d=await apiCall(f.name);document.getElementById("funcResult").textContent=JSON.stringify(d,null,2);}catch(e){document.getElementById("funcResult").textContent="שגיאה: "+e.message;}};bar.appendChild(b);});}

function detectYearLabel(n){const m=n.match(/תשפ.?/);if(m)return m[0];const g=n.match(/20\d{2}/);return g?g[0]:"לא ידוע";}
function detectSemesterLabel(n){if(/סמסטר.?א/.test(n))return"סמסטר א";if(/סמסטר.?ב/.test(n))return"סמסטר ב";if(/סמסטר.?ק/.test(n)||/קיץ/.test(n))return"סמסטר ק";if(/סמסטר.?ש/.test(n)||/שנתי/.test(n))return"סמסטר ש";return"לא מוגדר";}

function renderYears(){const bar=document.getElementById("yearsBar");bar.innerHTML="";const groups=new Map();state.courses.forEach(c=>{const y=detectYearLabel(c.fullname||"");if(!groups.has(y))groups.set(y,[]);groups.get(y).push(c);});groups.forEach((arr,y)=>{const b=document.createElement("button");b.className="pill";b.textContent=y;b.onclick=()=>renderSemesters(arr,y);bar.appendChild(b);});}
function renderSemesters(courses,y){state.selectedYear=y;document.getElementById("semesters").classList.remove("hidden");const bar=document.getElementById("semsBar");bar.innerHTML="";const groups=new Map();courses.forEach(c=>{const s=detectSemesterLabel(c.fullname||"");if(!groups.has(s))groups.set(s,[]);groups.get(s).push(c);});groups.forEach((arr,s)=>{const b=document.createElement("button");b.className="pill";b.textContent=s;b.onclick=()=>renderCourses(arr,s);bar.appendChild(b);});}
function renderCourses(courses,s){state.selectedSem=s;document.getElementById("courses").classList.remove("hidden");const bar=document.getElementById("coursesBar");bar.innerHTML="";courses.forEach(c=>{const b=document.createElement("button");b.className="pill";b.textContent=c.fullname;b.onclick=()=>openCourse(c);bar.appendChild(b);});}

async function openCourse(c){state.selectedCourse=c;document.getElementById("assignments").classList.remove("hidden");const users=await apiCall("core_enrol_get_enrolled_users",{courseid:c.id});state.enrolled.set(c.id,users);const data=await apiCall("mod_assign_get_assignments",{"courseids[0]":c.id});const assigns=data.courses[0]?.assignments||[];let html="<table><tr><th>מטלה</th><th>פתיחה</th><th>דדליין</th></tr>";assigns.forEach(a=>{html+=`<tr><td><button class="btn secondary" onclick="loadSubs(${a.id},'${a.name}')">${a.name}</button></td><td>${fmtDate(a.allowsubmissionsfromdate)}</td><td>${fmtDate(a.duedate)}</td></tr>`;});html+="</table>";document.getElementById("assignList").innerHTML=html;}

async function loadSubs(aid,name){
  state.assignId=aid;state.assignName=name;
  document.getElementById("subsTitle").textContent="הגשות במטלה: "+name;
  document.getElementById("submissions").classList.remove("hidden");
  document.getElementById("subsArea").innerHTML="טוען...";
  try{
    const [subs,grades]=await Promise.all([
      apiCall("mod_assign_get_submissions",{"assignmentids[0]":aid}),
      apiCall("mod_assign_get_grades",{"assignmentids[0]":aid})
    ]);
    const submissions=subs.assignments[0]?.submissions||[];
    const gradesMap=new Map();(grades.assignments[0]?.grades||[]).forEach(g=>gradesMap.set(g.userid,g));
    const users=state.enrolled.get(state.selectedCourse.id)||[];

    let html="<table><tr><th>סטודנט</th><th>קבצים</th><th>ציון</th><th>משוב</th><th>עדכון</th></tr>";
    for(const s of submissions){
      const u=users.find(x=>x.id===s.userid);
      const g=gradesMap.get(s.userid);
      const grade=fmtGrade(g?.grade);
      const fb=await getFeedback(aid,s.userid);

      const files=[];s.plugins?.forEach(p=>p.fileareas?.forEach(fa=>fa.files?.forEach(f=>{
        const url=f.fileurl.includes("token=")?f.fileurl:f.fileurl+"?token="+token;
        files.push(`<a href="${url}" target="_blank">${f.filename}</a>`);
      })));

      html+=`<tr>
        <td><b>${u?.fullname||s.userid}</b><br><span class="muted">${u?.email||""}</span></td>
        <td class="files">${files.join("<br>")||"—"}</td>
        <td>${grade}</td>
        <td><textarea id="fb_${s.userid}" class="fb-input" rows="2">${fb}</textarea></td>
        <td><input type="number" id="g_${s.userid}" class="grade-input" placeholder="${grade}"><button class="btn secondary" onclick="updateGrade(${aid},${s.userid})">שמור</button></td>
      </tr>`;
    }
    html+="</table>";
    document.getElementById("subsArea").innerHTML=html;
  }catch(e){document.getElementById("subsErr").textContent=e.message;document.getElementById("subsErr").classList.remove("hidden");}
}

async function getFeedback(aid,uid){
  try{
    const st=await apiCall("mod_assign_get_submission_status",{assignmentid:aid,userid:uid});
    const plugins=st.feedback?.plugins||[];
    for(const p of plugins){
      if(p.type==="comments"&&p.editorfields){return p.editorfields[0]?.text||"";}
    }
    return "";
  }catch{return "";}
}

async function updateGrade(aid,uid){
  const grade=document.getElementById(`g_${uid}`).value;
  const fb=document.getElementById(`fb_${uid}`).value;
  try{
    await apiCall("mod_assign_save_grade",{assignmentid:aid,userid:uid,grade:grade,attemptnumber:-1,"plugindata[assignfeedbackcomments_editor][text]":fb,"plugindata[assignfeedbackcomments_editor][format]":1});
    document.getElementById("subsMsg").textContent="עודכן בהצלחה";document.getElementById("subsMsg").classList.remove("hidden");
    loadSubs(aid,state.assignName);
  }catch(e){alert("שגיאה: "+e.message);}
}
</script>
</body>
</html>
