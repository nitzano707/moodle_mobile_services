<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#0b4d88;--accent:#0d63b5;--accent2:#0b58a4;--light:#f5f7fb;--card:#ffffff;--muted:#6b7280;--line:#e5e7eb}
    body{margin:0;background:var(--light);color:#1f2937;font-family:"Segoe UI","Rubik",Tahoma,Arial,sans-serif}
    header{background:var(--blue);color:#fff;padding:22px 16px}
    header .wrap{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{margin:0;font-size:22px}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap}
    .danger{background:#ffe8e8;color:#7a0d0d;border:1px solid #ffd1d1;padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:700}
    .container{max-width:1200px;margin:auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
    .pillbar{display:flex;flex-wrap:wrap;gap:10px}
    .pill{border:1px solid #dbe3ed;background:#eef2f7;padding:9px 13px;border-radius:999px;cursor:pointer;font-weight:600}
    .pill.selected{background:var(--accent);color:#fff}
    .crumbs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .crumb{background:#f1f5fb;border:1px solid #dbe3ed;border-radius:999px;padding:6px 10px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:6px 12px;cursor:pointer}
    .btn:hover{background:var(--accent2)}
    .btn.secondary{background:#eef3f9;color:#0b2743;border:1px solid #d4dbe6}
    .hidden{display:none!important}
    table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:right;vertical-align:top}
    th{background:#f0f4f8}
    tbody tr:nth-child(even){background:#f9fafb}
    .nowrap{white-space:nowrap}
    .files a{display:block;margin:2px 0;text-decoration:underline}
    .ok{padding:10px;background:#e9f9f2;border:1px solid #c7f0df;border-radius:10px;color:#0a7f48;margin-top:10px}
    .error{padding:10px;background:#ffecec;border:1px solid #ffc9c9;border-radius:10px;color:#7a0d0d;margin-top:10px}
    .grade-input{width:70px}
    .fb-input{width:100%;min-width:200px}
    .muted{color:var(--muted);font-size:0.9em}
    footer{text-align:center;color:#555;padding:15px;border-top:1px solid #ddd;margin-top:20px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</h1>
      <div class="top-actions">
        <button class="danger" onclick="deleteToken()">××—×§ Token ğŸ—‘ï¸</button>
      </div>
    </div>
  </header>

  <div class="container">

    <!-- Login -->
    <div id="loginScreen" class="card">
      <h2>×”×ª×—×‘×¨×•×ª ×¢× Token</h2>
      <input type="password" id="tokenInput" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”-Token" style="width:60%">
      <button class="btn" onclick="saveToken()">×©××•×¨</button>
    </div>

    <!-- Main -->
    <div id="mainScreen" class="hidden">
      <div id="crumbsBox" class="card hidden">
        <div class="crumbs">
          <div id="crumbYear" class="crumb hidden"></div>
          <div id="crumbSem" class="crumb hidden"></div>
          <div id="crumbCourse" class="crumb hidden"></div>
          <div id="crumbAssign" class="crumb hidden"></div>
          <button class="btn secondary" onclick="resetSelections()">× ×§×” ×‘×—×™×¨×•×ª</button>
        </div>
      </div>

      <div id="hierarchyTab">
        <div id="years" class="card">
          <h3>×©× ×•×ª ×œ×™××•×“</h3>
          <div id="yearsBar" class="pillbar"></div>
        </div>
        <div id="semesters" class="card hidden">
          <h3>×¡××¡×˜×¨×™×</h3>
          <div id="semsBar" class="pillbar"></div>
        </div>
        <div id="courses" class="card hidden">
          <h3>×§×•×¨×¡×™×</h3>
          <div id="coursesBar" class="pillbar"></div>
        </div>
        <div id="assignments" class="card hidden">
          <h3>××˜×œ×•×ª</h3>
          <div id="assignList"></div>
        </div>
        <div id="submissions" class="card hidden">
          <h3 id="subsTitle">×”×’×©×•×ª</h3>
          <div id="subsArea"></div>
          <div id="subsMsg" class="ok hidden"></div>
          <div id="subsErr" class="error hidden"></div>
        </div>
      </div>
    </div>

    <footer>×¤×•×ª×— ×¢"×™ ×“"×¨ × ×™×¦×Ÿ ××œ×™×§×™× | ×¡×‘×™×‘×ª Vibe Coding</footer>
  </div>

<script>
const baseUrl="https://moodle4.talpiot.ac.il";
let token=localStorage.getItem("moodleToken")||"";
const state={me:null,courses:[],selectedYear:null,selectedSem:null,selectedCourse:null,enrolled:new Map(),assignId:null,assignName:""};

window.onload=()=>{if(token)init();};

function saveToken(){token=document.getElementById("tokenInput").value.trim();if(!token)return;localStorage.setItem("moodleToken",token);init();}
function deleteToken(){localStorage.removeItem("moodleToken");location.reload();}

async function apiCall(wsfunction,params={}){
  const q=new URLSearchParams({wstoken:token,wsfunction,moodlewsrestformat:"json"});
  for(const[k,v]of Object.entries(params))q.append(k,v);
  const res=await fetch(`${baseUrl}/webservice/rest/server.php?${q}`);
  const d=await res.json();
  
  // ×‘×“×™×§×” ×™×•×ª×¨ ×—×›××” ×©×œ ×”×ª×’×•×‘×”
  if(d && (d.exception||d.errorcode)) {
    throw new Error(d.message||d.debuginfo||"API Error");
  }
  
  // ×× ×”×ª×’×•×‘×” null ××• undefined, ×–×” ××•××¨ ×‘×“×¨×š ×›×œ×œ ×©×”×¤×¢×•×œ×” ×”×¦×œ×™×—×”
  if(d === null || d === undefined) {
    return {};
  }
  
  return d;
}

const fmtDate=ts=>ts?new Date(ts*1000).toLocaleString():"â€“";
const fmtGrade=g=>(g==null||g==="")?"â€“":parseInt(g);

async function init(){
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("mainScreen").classList.remove("hidden");
  state.me=await apiCall("core_webservice_get_site_info");
  state.courses=await apiCall("core_enrol_get_users_courses",{userid:state.me.userid});
  renderYears();
}

function detectYearLabel(n){const m=n.match(/×ª×©×¤.?/);if(m)return m[0];const g=n.match(/20\d{2}/);return g?g[0]:"×œ× ×™×“×•×¢";}
function detectSemesterLabel(n){if(/×¡××¡×˜×¨.?×/.test(n))return"×¡××¡×˜×¨ ×";if(/×¡××¡×˜×¨.?×‘/.test(n))return"×¡××¡×˜×¨ ×‘";if(/×¡××¡×˜×¨.?×§/.test(n)||/×§×™×¥/.test(n))return"×¡××¡×˜×¨ ×§";if(/×¡××¡×˜×¨.?×©/.test(n)||/×©× ×ª×™/.test(n))return"×¡××¡×˜×¨ ×©";return"×œ× ××•×’×“×¨";}

function renderYears(){const bar=document.getElementById("yearsBar");bar.innerHTML="";const groups=new Map();state.courses.forEach(c=>{const y=detectYearLabel(c.fullname||"");if(!groups.has(y))groups.set(y,[]);groups.get(y).push(c);});groups.forEach((arr,y)=>{const b=document.createElement("button");b.className="pill";b.textContent=y;b.onclick=()=>renderSemesters(arr,y);bar.appendChild(b);});}

function renderSemesters(courses,y){state.selectedYear=y;document.getElementById("semesters").classList.remove("hidden");const bar=document.getElementById("semsBar");bar.innerHTML="";const groups=new Map();courses.forEach(c=>{const s=detectSemesterLabel(c.fullname||"");if(!groups.has(s))groups.set(s,[]);groups.get(s).push(c);});groups.forEach((arr,s)=>{const b=document.createElement("button");b.className="pill";b.textContent=s;b.onclick=()=>renderCourses(arr,s);bar.appendChild(b);});}

function renderCourses(courses,s){state.selectedSem=s;document.getElementById("courses").classList.remove("hidden");const bar=document.getElementById("coursesBar");bar.innerHTML="";courses.forEach(c=>{const b=document.createElement("button");b.className="pill";b.textContent=c.fullname;b.onclick=()=>openCourse(c);bar.appendChild(b);});}

async function openCourse(c){state.selectedCourse=c;document.getElementById("assignments").classList.remove("hidden");const users=await apiCall("core_enrol_get_enrolled_users",{courseid:c.id});state.enrolled.set(c.id,users);const data=await apiCall("mod_assign_get_assignments",{"courseids[0]":c.id});const assigns=data.courses[0]?.assignments||[];let html="<table><tr><th>××˜×œ×”</th><th>×¤×ª×™×—×”</th><th>×“×“×œ×™×™×Ÿ</th></tr>";assigns.forEach(a=>{html+=`<tr><td><button class="btn secondary" onclick="loadSubs(${a.id},'${a.name}')">${a.name}</button></td><td>${fmtDate(a.allowsubmissionsfromdate)}</td><td>${fmtDate(a.duedate)}</td></tr>`;});html+="</table>";document.getElementById("assignList").innerHTML=html;}

async function loadSubs(aid,name){
  state.assignId=aid;state.assignName=name;
  document.getElementById("subsTitle").textContent="×”×’×©×•×ª ×‘××˜×œ×”: "+name;
  document.getElementById("submissions").classList.remove("hidden");
  document.getElementById("subsArea").innerHTML="×˜×•×¢×Ÿ...";
  document.getElementById("subsMsg").classList.add("hidden");
  document.getElementById("subsErr").classList.add("hidden");
  
  try{
    // ×§×‘×œ×ª ×¤×¨×˜×™ ×”××˜×œ×” ×›×•×œ×œ ×”× ×—×™×•×ª ×•××—×•×•×Ÿ
    const assignmentDetails = await getAssignmentDetails(aid);
    
    const [subs,grades]=await Promise.all([
      apiCall("mod_assign_get_submissions",{"assignmentids[0]":aid}),
      apiCall("mod_assign_get_grades",{"assignmentids[0]":aid})
    ]);
    const submissions=subs.assignments[0]?.submissions||[];
    const gradesMap=new Map();(grades.assignments[0]?.grades||[]).forEach(g=>gradesMap.set(g.userid,g));
    const users=state.enrolled.get(state.selectedCourse.id)||[];

    // ×‘× ×™×™×ª HTML ×¢×‘×•×¨ ×”× ×—×™×•×ª ×”××˜×œ×”
    let assignmentInfoHtml = "";
    if(assignmentDetails.intro) {
      assignmentInfoHtml = `<div class="card" style="background:#f8f9ff;border-color:#d4dbe6;margin-bottom:16px;">
        <h4 style="margin:0 0 10px 0;">×”× ×—×™×•×ª ×”××˜×œ×”:</h4>
        <div style="border:1px solid #e5e7eb;padding:12px;border-radius:8px;background:white;">
          ${assignmentDetails.intro}
        </div>
      </div>`;
    }

    // ×‘× ×™×™×ª HTML ×¢×‘×•×¨ ××—×•×•×Ÿ (×× ×§×™×™×)
    let rubricHtml = "";
    const rubricCriteria = assignmentDetails.rubric || [];
    
    if(rubricCriteria.length > 0) {
      rubricHtml = `<div class="card" style="background:#fff8f0;border-color:#e6ddd4;margin-bottom:16px;">
        <h4 style="margin:0 0 10px 0;">××—×•×•×Ÿ ×”×¢×¨×›×”:</h4>
        <table style="margin-top:10px;">
          <thead>
            <tr>
              <th>×§×¨×™×˜×¨×™×•×Ÿ</th>
              <th>×ª×™××•×¨</th>
              <th>× ×™×§×•×“ ××§×¡×™××œ×™</th>
            </tr>
          </thead>
          <tbody>`;
      
      rubricCriteria.forEach(criterion => {
        rubricHtml += `
          <tr>
            <td><strong>${criterion.shortname || '×§×¨×™×˜×¨×™×•×Ÿ'}</strong></td>
            <td>${criterion.description || ''}</td>
            <td>${criterion.maxscore}</td>
          </tr>`;
      });
      
      rubricHtml += `</tbody></table></div>`;
    }

    // ×‘× ×™×™×ª ×›×•×ª×¨×•×ª ×”×˜×‘×œ×”
    let tableHeaders = "<thead><tr><th>×¡×˜×•×“× ×˜</th><th>×§×‘×¦×™×</th><th>×¦×™×•×Ÿ ×›×œ×œ×™</th>";
    
    // ×”×•×¡×¤×ª ×¢××•×“×•×ª ×§×¨×™×˜×¨×™×•× ×™× ×× ×™×© ××—×•×•×Ÿ
    if(rubricCriteria.length > 0) {
      rubricCriteria.forEach(criterion => {
        tableHeaders += `<th style="min-width:140px;max-width:200px;">
          <div><strong>${criterion.shortname || '×§×¨×™×˜×¨×™×•×Ÿ'}</strong></div>
          <div class="muted" style="font-size:0.8em;font-weight:normal;">× ×™×§×•×“ ×•××©×•×‘</div>
        </th>`;
      });
    }
    
    tableHeaders += "<th>××©×•×‘ ×›×œ×œ×™</th><th>×¢×“×›×•×Ÿ</th></tr></thead>";

    // ×‘× ×™×™×ª ×©×•×¨×•×ª ×”×˜×‘×œ×”
    let tableRows = "<tbody>";
    
    for(const s of submissions){
      const u=users.find(x=>x.id===s.userid);
      const g=gradesMap.get(s.userid);
      const grade=fmtGrade(g?.grade);
      const fb=await getFeedback(aid,s.userid);
      
      // ×§×‘×œ×ª ×¤×¨×˜×™ ××—×•×•×Ÿ ×¢×‘×•×¨ ×”×¡×˜×•×“× ×˜
      const rubricFeedback = await getRubricFeedback(aid, s.userid);
      
      const files=[];s.plugins?.forEach(p=>p.fileareas?.forEach(fa=>fa.files?.forEach(f=>{
        const url=f.fileurl.includes("token=")?f.fileurl:f.fileurl+"?token="+token;
        files.push(`<a href="${url}" target="_blank">${f.filename}</a>`);
      })));

      tableRows += `<tr>
        <td>
          <div><strong>${u?.fullname||s.userid}</strong></div>
          <div class="muted" style="font-size:0.85em;">${u?.email||`ID: ${s.userid}`}</div>
        </td>
        <td class="files">${files.join("<br>")||"<span class='muted'>â€”</span>"}</td>
        <td style="text-align:center;"><strong>${grade}</strong></td>`;

      // ×”×•×¡×¤×ª ×¢××•×“×•×ª ×§×¨×™×˜×¨×™×•× ×™×
      if(rubricCriteria.length > 0) {
        rubricCriteria.forEach(criterion => {
          const criterionId = criterion.id;
          const criterionData = rubricFeedback[criterionId] || {};
          const score = criterionData.score || 'â€”';
          const remark = criterionData.remark || '';
          
          tableRows += `<td style="font-size:0.9em;vertical-align:top;border-left:2px solid #e3f2fd;padding:8px;">
            <div style="margin-bottom:6px;">
              <strong style="color:#1976d2;font-size:1em;">× ×™×§×•×“: ${score}</strong>
              ${criterion.maxscore ? `<span class="muted" style="font-size:0.8em;"> / ${criterion.maxscore}</span>` : ''}
            </div>
            <div style="border-top:1px dashed #ddd;padding-top:4px;">
              <textarea id="rubric_${s.userid}_${criterionId}" 
                        style="width:100%;min-height:50px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:0.85em;resize:vertical;" 
                        placeholder="××©×•×‘ ×œ×§×¨×™×˜×¨×™×•×Ÿ ×–×”...">${remark}</textarea>
            </div>
          </td>`;
        });
      }

      tableRows += `
        <td><textarea id="fb_${s.userid}" class="fb-input" rows="2" placeholder="××©×•×‘ ×›×œ×œ×™ ×œ××˜×œ×”...">${fb}</textarea></td>
        <td class="nowrap">
          <div><input type="number" step="0.01" id="g_${s.userid}" class="grade-input" placeholder="${grade === 'â€“' ? '×¦×™×•×Ÿ' : ''}" value="${grade !== 'â€“' ? grade : ''}"></div>
          <div style="margin-top:4px;"><button class="btn secondary" onclick="updateGrade(${aid},${s.userid})">×©××•×¨</button></div>
        </td>
      </tr>`;
    }
    tableRows += "</tbody>";

    const finalHtml = assignmentInfoHtml + rubricHtml + `<table style="margin-top:10px;">${tableHeaders}${tableRows}</table>`;
    document.getElementById("subsArea").innerHTML = finalHtml;
    
  }catch(e){
    console.error("Error loading submissions:", e);
    document.getElementById("subsErr").textContent="×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×©×•×ª: " + e.message;
    document.getElementById("subsErr").classList.remove("hidden");
  }
}

async function getFeedback(aid,uid){
  try{
    const st=await apiCall("mod_assign_get_submission_status",{assignid:aid,userid:uid});
    const plugins=st?.feedback?.plugins||[];
    for(const p of plugins){
      if(p.type==="comments"&&p.editorfields){
        return p.editorfields[0]?.text||"";
      }
    }
    return "";
  }catch{return "";}
}

async function getAssignmentDetails(assignmentId) {
  try {
    // ×§×‘×œ×ª ×¤×¨×˜×™ ×”××˜×œ×”
    const assignData = await apiCall("mod_assign_get_assignments", {"courseids[0]": state.selectedCourse.id});
    const assignment = assignData.courses?.[0]?.assignments?.find(a => a.id == assignmentId);
    
    if (!assignment) return { intro: "", rubric: [] };

    console.log("Assignment details:", assignment);

    // ×‘×“×™×§×” ×× ×”××˜×œ×” ××©×ª××©×ª ×‘×©×™×˜×ª ×¦×™×•×Ÿ ××ª×§×“××ª (××—×•×•×Ÿ/guide)
    let rubricData = [];
    
    // ×‘×“×•×§ ×× ×™×© ×”×’×“×¨×” ×©×œ advanced grading ××• marking guide
    if (assignment.advancedgrading || assignment.markingguide || 
        (assignment.configs && assignment.configs.some(c => c.plugin === 'rubric' || c.plugin === 'guide')) ||
        (assignment.grade && assignment.grade > 100)) { // ×¦×™×•×Ÿ ×’×‘×•×” ×-100 ×¢×©×•×™ ×œ×”×¦×‘×™×¢ ×¢×œ ××—×•×•×Ÿ
      
      console.log("Found potential advanced grading setup");
      
      // × ×¡×” ×œ××¦×•× ××™×“×¢ ×¢×œ ×”××—×•×•×Ÿ ×××˜×œ×” ×¢× ×¦×™×•×Ÿ ×§×™×™×
      try {
        const grades = await apiCall("mod_assign_get_grades", {"assignmentids[0]": assignmentId});
        const gradesWithFeedback = (grades.assignments?.[0]?.grades || []).filter(g => g.gradeddate);
        
        for (const grade of gradesWithFeedback.slice(0, 2)) {
          const status = await apiCall("mod_assign_get_submission_status", {
            assignid: assignmentId,
            userid: grade.userid
          });
          
          const plugins = status?.feedback?.plugins || [];
          console.log(`Plugins for graded user ${grade.userid}:`, plugins.map(p => p.type));
          
          for (const plugin of plugins) {
            // ×—×¤×© ×¤×œ××’×™×Ÿ ×©×œ ××—×•×•×Ÿ ××• guide
            if (plugin.type && (plugin.type.includes('rubric') || plugin.type.includes('guide') || 
                                plugin.type.includes('gradingform') || plugin.type === 'grading')) {
              
              console.log(`Found grading plugin: ${plugin.type}`, plugin);
              
              if (plugin.criterias || plugin.criteria) {
                const criteria = plugin.criterias || plugin.criteria;
                console.log("Criteria found:", criteria);
                
                if (Array.isArray(criteria)) {
                  criteria.forEach((criterion, index) => {
                    rubricData.push({
                      id: criterion.id || criterion.criterionid || index,
                      shortname: criterion.shortname || criterion.description || `×§×¨×™×˜×¨×™×•×Ÿ ${index + 1}`,
                      description: criterion.description || "",
                      maxscore: criterion.maxscore || criterion.levels?.reduce((max, level) => Math.max(max, level.score || 0), 0) || '?'
                    });
                  });
                } else if (typeof criteria === 'object') {
                  Object.entries(criteria).forEach(([key, criterion]) => {
                    rubricData.push({
                      id: key,
                      shortname: criterion.shortname || criterion.description || `×§×¨×™×˜×¨×™×•×Ÿ ${rubricData.length + 1}`,
                      description: criterion.description || "",
                      maxscore: criterion.maxscore || '?'
                    });
                  });
                }
                
                if (rubricData.length > 0) break;
              }
            }
          }
          
          if (rubricData.length > 0) break;
        }
      } catch (e) {
        console.log("Error detecting rubric from graded submissions:", e);
      }
    }
    
    console.log("Final detected rubric criteria:", rubricData);

    return {
      intro: assignment.intro || assignment.description || "",
      rubric: rubricData
    };
    
  } catch (e) {
    console.error("Error getting assignment details:", e);
    return { intro: "", rubric: [] };
  }
}

async function getRubricFeedback(assignmentId, userId) {
  try {
    const status = await apiCall("mod_assign_get_submission_status", {
      assignid: assignmentId,
      userid: userId
    });

    const rubricData = {};
    const plugins = status?.feedback?.plugins || [];
    
    // × ×—×¤×© ××™×“×¢ ×¢×œ ××—×•×•×Ÿ ×‘×ª×•×š ×”×¤×œ××’×™× ×™× ×”×§×™×™××™×
    plugins.forEach(plugin => {
      console.log("Plugin found:", plugin.type, plugin); // ×œ×“×™×‘×•×’
      
      // ×× ×™×© criterias ××• ××©×”×• ×“×•××”
      if (plugin.criterias || plugin.criteria) {
        const criteria = plugin.criterias || plugin.criteria;
        
        if (Array.isArray(criteria)) {
          criteria.forEach(criterion => {
            const id = criterion.id || criterion.criterionid || Object.keys(rubricData).length;
            rubricData[id] = {
              score: criterion.score || criterion.grade || criterion.points || 'â€”',
              remark: criterion.remark || criterion.comment || criterion.description || ''
            };
          });
        } else if (typeof criteria === 'object') {
          Object.entries(criteria).forEach(([key, criterion]) => {
            rubricData[key] = {
              score: criterion.score || criterion.grade || criterion.points || 'â€”',
              remark: criterion.remark || criterion.comment || criterion.description || ''
            };
          });
        }
      }
      
      // × ×—×¤×© ×’× ×‘×©×“×•×ª ××—×¨×™×
      if (plugin.fileareas) {
        plugin.fileareas.forEach(area => {
          if (area.area === 'rubric' && area.files) {
            console.log("Found rubric files:", area.files);
          }
        });
      }
    });

    return rubricData;
  } catch (e) {
    console.error("Error getting rubric feedback:", e);
    return {};
  }
}

async function updateGrade(aid, uid) {
  const gradeInput = document.getElementById(`g_${uid}`);
  const fbInput = document.getElementById(`fb_${uid}`);
  const grade = gradeInput.value.trim();
  const fb = fbInput.value;
  
  // × ×§×” ×”×•×“×¢×•×ª ×§×•×“××•×ª
  document.getElementById("subsMsg").classList.add("hidden");
  document.getElementById("subsErr").classList.add("hidden");
  
  try {
    console.log(`Updating grade for user ${uid}, grade: ${grade}`);
    
    // ××™×¡×•×£ ×›×œ ×”××©×•×‘ ×©×œ ×”×§×¨×™×˜×¨×™×•× ×™×
    const rubricFeedbacks = {};
    const rubricInputs = document.querySelectorAll(`[id^="rubric_${uid}_"]`);
    
    rubricInputs.forEach(input => {
      const match = input.id.match(/^rubric_\d+_(.+)$/);
      if (match) {
        const criterionId = match[1];
        rubricFeedbacks[criterionId] = input.value.trim();
        console.log(`Found rubric feedback for criterion ${criterionId}:`, input.value.trim());
      }
    });

    // ××©×ª××© ×‘×¤×¨××˜×¨×™× ×”× ×›×•× ×™× ×›××• ×‘×§×•×“ ×”×¢×•×‘×“
    const params = {
      assignmentid: aid,
      userid: uid,
      attemptnumber: -1,
      addattempt: 0,
      workflowstate: "graded",
      applytoall: 0,
      "plugindata[assignfeedbackcomments_editor][text]": fb || "",
      "plugindata[assignfeedbackcomments_editor][format]": 1
    };
    
    // ×”×•×¡×£ ×¦×™×•×Ÿ ×× ×§×™×™×
    if (grade !== "") {
      params.grade = grade;
    }

    // ×”×•×¡×£ ××©×•×‘ ×§×¨×™×˜×¨×™×•× ×™× ×× ×™×©
    if (Object.keys(rubricFeedbacks).length > 0) {
      // × × ×¡×” ×¤×•×¨××˜×™× ×©×•× ×™× ×œ××©×•×‘ ××—×•×•×Ÿ
      let rubricIndex = 0;
      Object.entries(rubricFeedbacks).forEach(([criterionId, feedback]) => {
        if (feedback) {
          // ×¤×•×¨××˜ 1: rubric grading
          params[`advancedgradingdata[criteria][${criterionId}][remark]`] = feedback;
          
          // ×¤×•×¨××˜ 2: guide grading  
          params[`advancedgradingdata[guide][criteria][${criterionId}][remark]`] = feedback;
          
          // ×¤×•×¨××˜ 3: ×’×™×©×” ××—×¨×ª
          params[`plugindata[gradingform_rubric][criterion_${criterionId}_remark]`] = feedback;
          
          // ×¤×•×¨××˜ 4: ×¢×•×“ ×’×™×©×”
          params[`gradingform_rubric_instance_criterion_${criterionId}_remark`] = feedback;
          
          rubricIndex++;
        }
      });
      
      console.log("Added rubric feedback params:", Object.keys(params).filter(k => k.includes('criteria') || k.includes('rubric')));
    }
    
    console.log("API params:", params);
    
    // ×©××•×¨ ××ª ×”×¦×™×•×Ÿ ×•×”××©×•×‘
    const result = await apiCall("mod_assign_save_grade", params);
    console.log("Save grade result:", result);
    
    document.getElementById("subsMsg").textContent = "×”×¦×™×•×Ÿ ×•×”××©×•×‘ ×¢×•×“×›× ×• ×‘×”×¦×œ×—×” (×›×•×œ×œ ×§×¨×™×˜×¨×™×•× ×™ ××—×•×•×Ÿ)!";
    document.getElementById("subsMsg").classList.remove("hidden");
    
    // ××¨×¢× ×Ÿ ××ª ×”×˜×‘×œ×” ××—×¨×™ 1.5 ×©× ×™×™×”
    setTimeout(() => {
      loadSubs(aid, state.assignName);
    }, 1500);
    
  } catch (e) {
    console.error("Error updating grade:", e);
    document.getElementById("subsErr").textContent = "×¢×“×›×•×Ÿ × ×›×©×œ: " + e.message + "\n(×”×¦×™×•×Ÿ ×”×›×œ×œ×™ ×•×”××©×•×‘ ×”×›×œ×œ×™ ×××•×¨×™× ×œ×”×™×©××¨, ××‘×œ ×™×™×ª×›×Ÿ ×©××©×•×‘ ×”×§×¨×™×˜×¨×™×•× ×™× ×œ× × ×©××¨)";
    document.getElementById("subsErr").classList.remove("hidden");
  }
}

function resetSelections() {
  state.selectedYear = null;
  state.selectedSem = null;
  state.selectedCourse = null;
  state.assignId = null;
  state.assignName = "";
  
  // ×”×¡×ª×¨ ××ª ×›×œ ×”×§×˜×¢×™×
  document.getElementById("crumbsBox").classList.add("hidden");
  document.getElementById("semesters").classList.add("hidden");
  document.getElementById("courses").classList.add("hidden");
  document.getElementById("assignments").classList.add("hidden");
  document.getElementById("submissions").classList.add("hidden");
  
  // ×—×–×•×¨ ×œ×¨×™× ×“×•×¨ ×”×©× ×™×
  renderYears();
}
</script>
</body>
</html>
