<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Moodle API Explorer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
    .hidden { display: none; }
    button { margin: 5px; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
    #result { white-space: pre-wrap; background: #f5f5f5; padding: 10px; border: 1px solid #ccc; margin-top: 10px; max-height: 400px; overflow-y: auto; }
    #home { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>🔑 חיבור ל־Moodle API</h1>

  <!-- מסך כניסת טוקן -->
  <div id="loginScreen">
    <label for="tokenInput">הכנס Token:</label>
    <input type="text" id="tokenInput" size="60">
    <br><br>
    <label for="urlInput">כתובת האתר (ללא /webservice/...):</label>
    <input type="text" id="urlInput" size="60" placeholder="https://www.talpiot.ac.il">
    <br><br>
    <button onclick="saveToken()">שמור והמשך</button>
  </div>

  <!-- מסך ראשי -->
  <div id="mainScreen" class="hidden">
    <h2>📌 בחר פונקציה</h2>
    <div id="functions"></div>
    <div id="result"></div>
    <div id="home">
      <button onclick="goHome()">🏠 חזרה</button>
      <button onclick="deleteToken()">🗑️ מחק Token</button>
    </div>
  </div>

  <script>
    const functionsList = [
      {name: "מידע על האתר", func: "core_webservice_get_site_info"},
      {name: "קורסים לפי מזהה", func: "core_course_get_courses_by_field&field=id&value=1"},
      {name: "תכני קורסים", func: "core_course_get_contents&courseid=1"},
      {name: "מטלות", func: "mod_assign_get_assignments"},
      {name: "משתמשים לפי אימייל", func: "core_user_get_users_by_field&field=email&values[0]=test@example.com"}
    ];

    const loginScreen = document.getElementById("loginScreen");
    const mainScreen = document.getElementById("mainScreen");
    const functionsDiv = document.getElementById("functions");
    const resultDiv = document.getElementById("result");

    // טוען טוקן מה-localStorage
    window.onload = () => {
      if (localStorage.getItem("moodleToken") && localStorage.getItem("moodleUrl")) {
        showMain();
      }
    };

    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      const url = document.getElementById("urlInput").value.trim();
      if (!token || !url) {
        alert("נא להזין טוקן וכתובת אתר");
        return;
      }
      localStorage.setItem("moodleToken", token);
      localStorage.setItem("moodleUrl", url);
      showMain();
    }

    function showMain() {
      loginScreen.classList.add("hidden");
      mainScreen.classList.remove("hidden");
      functionsDiv.innerHTML = "";
      functionsList.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.name;
        btn.onclick = () => callFunction(item.func);
        functionsDiv.appendChild(btn);
      });
    }

    async function callFunction(func) {
      const token = localStorage.getItem("moodleToken");
      const url = localStorage.getItem("moodleUrl");
      resultDiv.textContent = "⏳ מבצע קריאה ל־API...";
      try {
        const res = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=${func}&moodlewsrestformat=json`);
        const data = await res.json();
        resultDiv.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        resultDiv.textContent = "❌ שגיאה: " + err;
      }
    }

    function goHome() {
      resultDiv.textContent = "";
      window.scrollTo(0, 0);
    }

    function deleteToken() {
      localStorage.removeItem("moodleToken");
      localStorage.removeItem("moodleUrl");
      mainScreen.classList.add("hidden");
      loginScreen.classList.remove("hidden");
    }
  </script>
</body>
</html>
