<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; direction: rtl; }
    h1 { margin-bottom: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 8px 12px; border-radius: 6px; cursor: pointer; background:#fff; border:1px solid #ccc; }
    button:hover { background:#eef; }
    #result { white-space: pre-wrap; background: #fff; padding: 10px; border: 1px solid #ccc; margin-top: 10px; max-height:400px; overflow-y:auto; }
    .tabs { margin-bottom:20px; }
    .tabs button { margin-left:10px; }
    .section { background:#fff; border:1px solid #ddd; border-radius:6px; padding:10px; margin-bottom:15px; }
  </style>
</head>
<body>
  <h1>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</h1>

  <!-- ××¡×š ×›× ×™×¡×” -->
  <div id="loginScreen">
    <label>Token:</label><br>
    <input type="text" id="tokenInput" size="60"><br><br>
    <button onclick="saveToken()">×©××•×¨ ×•×”×ª×—×‘×¨</button>
  </div>

  <!-- ××¡×š ×¨××©×™ -->
  <div id="mainScreen" class="hidden">
    <div class="tabs">
      <button onclick="showTab('hierarchy')">ğŸ“š ×××©×§ ×”×™×¨×¨×›×™</button>
      <button onclick="showTab('functions')">âš™ï¸ ×›×œ ×”×¤×•× ×§×¦×™×•×ª ×”×–××™× ×•×ª ×œ×™</button>
      <button onclick="deleteToken()">ğŸ—‘ï¸ ××—×§ Token</button>
    </div>

    <div id="hierarchyTab" class="tab">
      <div id="years"></div>
      <div id="semesters"></div>
      <div id="courses"></div>
      <div id="assignments"></div>
      <div id="submissions"></div>
    </div>

    <div id="functionsTab" class="tab hidden">
      <h3>×¨×©×™××ª ×¤×•× ×§×¦×™×•×ª ××”Ö¾token ×©×œ×š</h3>
      <div id="functions"></div>
      <div id="result"></div>
    </div>
  </div>

  <script>
    const baseUrl = "https://moodle4.talpiot.ac.il";
    let token = localStorage.getItem("moodleToken") || "";

    const loginScreen = document.getElementById("loginScreen");
    const mainScreen = document.getElementById("mainScreen");

    window.onload = () => { if (token) init(); };

    function saveToken() {
      token = document.getElementById("tokenInput").value.trim();
      if (!token) { alert("× × ×œ×”×–×™×Ÿ ×˜×•×§×Ÿ"); return; }
      localStorage.setItem("moodleToken", token);
      init();
    }

    function deleteToken() {
      localStorage.removeItem("moodleToken");
      location.reload();
    }

    function showTab(tab) {
      document.getElementById("hierarchyTab").classList.add("hidden");
      document.getElementById("functionsTab").classList.add("hidden");
      if (tab === "hierarchy") document.getElementById("hierarchyTab").classList.remove("hidden");
      if (tab === "functions") document.getElementById("functionsTab").classList.remove("hidden");
    }

    async function init() {
      loginScreen.classList.add("hidden");
      mainScreen.classList.remove("hidden");
      await loadFunctions();
      await loadCourses();
    }

    // ---- ×¤×•× ×§×¦×™×•×ª ×›×œ×œ×™×•×ª ----
    async function apiCall(func, params={}) {
      const q = new URLSearchParams({ wstoken: token, wsfunction: func, moodlewsrestformat:"json" });
      for (const [k,v] of Object.entries(params)) q.append(k,v);
      const res = await fetch(`${baseUrl}/webservice/rest/server.php?${q}`);
      return await res.json();
    }

    // ---- ×¤×•× ×§×¦×™×•×ª ×–××™× ×•×ª ----
    async function loadFunctions() {
      const info = await apiCall("core_webservice_get_site_info");
      const funcs = info.functions || [];
      const div = document.getElementById("functions");
      div.innerHTML = "";
      funcs.forEach(f => {
        const btn = document.createElement("button");
        btn.textContent = f.name;
        btn.onclick = async () => {
          const data = await apiCall(f.name);
          document.getElementById("result").textContent = JSON.stringify(data,null,2);
        };
        div.appendChild(btn);
      });
    }

    // ---- ×××©×§ ×”×™×¨×¨×›×™ ----
    async function loadCourses() {
      const info = await apiCall("core_webservice_get_site_info");
      const courses = await apiCall("core_enrol_get_users_courses", { userid: info.userid });
      // ×—×œ×•×§×” ×œ×¤×™ ×©× ×”
      const yearsDiv = document.getElementById("years");
      yearsDiv.innerHTML = "<h3>×©× ×•×ª ×œ×™××•×“</h3>";
      const years = {};
      courses.forEach(c => {
        const year = (c.fullname.match(/20\\d{2}/)||["××—×¨"])[0];
        if (!years[year]) years[year]=[];
        years[year].push(c);
      });
      Object.keys(years).forEach(y=>{
        const btn=document.createElement("button");
        btn.textContent=y;
        btn.onclick=()=>showSemesters(years[y]);
        yearsDiv.appendChild(btn);
      });
    }

    function showSemesters(courses) {
      document.getElementById("semesters").innerHTML="<h3>×¡××¡×˜×¨×™×</h3>";
      document.getElementById("courses").innerHTML="";
      const sems={};
      courses.forEach(c=>{
        const sem=(c.fullname.match(/×¡××¡×˜×¨.?[××‘]/)||["×œ× ××•×’×“×¨"])[0];
        if(!sems[sem]) sems[sem]=[];
        sems[sem].push(c);
      });
      Object.keys(sems).forEach(s=>{
        const btn=document.createElement("button");
        btn.textContent=s;
        btn.onclick=()=>showCourses(sems[s]);
        document.getElementById("semesters").appendChild(btn);
      });
    }

    function showCourses(courses) {
      const div=document.getElementById("courses");
      div.innerHTML="<h3>×§×•×¨×¡×™×</h3>";
      courses.forEach(c=>{
        const btn=document.createElement("button");
        btn.textContent=c.fullname;
        btn.onclick=()=>loadAssignments(c.id);
        div.appendChild(btn);
      });
    }

    async function loadAssignments(courseid) {
      const data=await apiCall("mod_assign_get_assignments", {"courseids[0]":courseid});
      const assigns=(data.courses && data.courses[0])?data.courses[0].assignments:[];
      const div=document.getElementById("assignments");
      div.innerHTML="<h3>××˜×œ×•×ª</h3>";
      assigns.forEach(a=>{
        const btn=document.createElement("button");
        btn.textContent=a.name;
        btn.onclick=()=>loadSubmissions(a.id);
        div.appendChild(btn);
      });
    }

    async function loadSubmissions(assignid) {
      const data=await apiCall("mod_assign_get_submissions", {"assignmentids[0]":assignid});
      const subs=(data.assignments && data.assignments[0])?data.assignments[0].submissions:[];
      const div=document.getElementById("submissions");
      div.innerHTML="<h3>×”×’×©×•×ª</h3><pre>"+JSON.stringify(subs,null,2)+"</pre>";
    }
  </script>
</body>
</html>
