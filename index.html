<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Moodle API Explorer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; background:#f8f9fa; }
    h1 { margin-bottom: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    #result { white-space: pre-wrap; background: #fff; padding: 10px; border: 1px solid #ccc; margin-top: 10px; max-height: 400px; overflow-y: auto; }
    #functions button { display:block; margin:5px 0; width:100%; text-align:right; }
  </style>
</head>
<body>
  <h1>📌 Moodle API Explorer</h1>

  <!-- מסך כניסה -->
  <div id="loginScreen">
    <label>כתובת Moodle:</label><br>
    <input type="text" id="urlInput" size="60" placeholder="https://moodle4.talpiot.ac.il"><br><br>

    <label>Token:</label><br>
    <input type="text" id="tokenInput" size="60"><br><br>

    <button onclick="saveToken()">שמור והתחבר</button>
  </div>

  <!-- מסך ראשי -->
  <div id="mainScreen" class="hidden">
    <h2>בחר פונקציה:</h2>
    <div id="functions"></div>
    <div id="result"></div>
    <br>
    <button onclick="goHome()">🏠 חזרה</button>
    <button onclick="deleteToken()">🗑️ מחק Token</button>
  </div>

  <script>
    const functionsList = [
      {name: "מידע על המשתמש והאתר", func: "core_webservice_get_site_info"},
      {name: "הקורסים שלי", func: "core_enrol_get_users_courses"},
      {name: "מטלות בקורסים שלי", func: "mod_assign_get_assignments"},
      {name: "תכני קורס (id=2)", func: "core_course_get_contents&courseid=2"},
      {name: "סטודנטים בקורס (id=2)", func: "core_enrol_get_enrolled_users&courseid=2"}
    ];

    const loginScreen = document.getElementById("loginScreen");
    const mainScreen = document.getElementById("mainScreen");
    const functionsDiv = document.getElementById("functions");
    const resultDiv = document.getElementById("result");

    window.onload = () => {
      if (localStorage.getItem("moodleToken") && localStorage.getItem("moodleUrl")) {
        showMain();
      }
    };

    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      const url = document.getElementById("urlInput").value.trim();
      if (!token || !url) { alert("נא להזין כתובת וטוקן"); return; }
      localStorage.setItem("moodleToken", token);
      localStorage.setItem("moodleUrl", url);
      showMain();
    }

    function showMain() {
      loginScreen.classList.add("hidden");
      mainScreen.classList.remove("hidden");
      functionsDiv.innerHTML = "";
      functionsList.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.name;
        btn.onclick = () => callFunction(item.func);
        functionsDiv.appendChild(btn);
      });
    }

    async function callFunction(func) {
      const token = localStorage.getItem("moodleToken");
      const url = localStorage.getItem("moodleUrl");
      resultDiv.textContent = "⏳ טוען...";
      try {
        const res = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=${func}&moodlewsrestformat=json`);
        const data = await res.json();
        resultDiv.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        resultDiv.textContent = "❌ שגיאה: " + err;
      }
    }

    function goHome() { resultDiv.textContent = ""; window.scrollTo(0,0); }
    function deleteToken() {
      localStorage.removeItem("moodleToken");
      localStorage.removeItem("moodleUrl");
      mainScreen.classList.add("hidden");
      loginScreen.classList.remove("hidden");
    }
  </script>
</body>
</html>
