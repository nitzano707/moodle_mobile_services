<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --blue:#0b4d88; --accent:#0d63b5; --accent2:#0b58a4; --light:#f5f7fb; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb }
    *{box-sizing:border-box}
    body{margin:0;background:var(--light);color:#1f2937;font-family:"Segoe UI","Rubik",Tahoma,Arial,sans-serif}
    header{background:var(--blue);color:#fff;padding:22px 16px}
    header .wrap{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{margin:0;font-size:clamp(18px,2.6vw,28px)}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #ccd6e4;background:var(--accent);color:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--accent2)}
    .btn.secondary{background:#eef3f9;color:#0b2743;border:1px solid #d4dbe6}
    .btn.danger{background:#ffe8e8;color:#7a0d0d;border-color:#ffd1d1}
    .container{max-width:1200px;margin:auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .section-title{margin:0 0 10px;font-size:19px}
    .hidden{display:none}
    .muted{color:var(--muted)}
    .pillbar{display:flex;flex-wrap:wrap;gap:10px}
    .pill{border:1px solid #dbe3ed;background:#eef2f7;padding:9px 13px;border-radius:999px;cursor:pointer;font-weight:600}
    .pill.selected{background:var(--accent);color:#fff;border-color:#0a4c8a}
    .crumbs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .crumb{background:#f1f5fb;border:1px solid #dbe3ed;border-radius:999px;padding:6px 10px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    thead th{background:#f2f5f9;text-align:right;padding:10px;border-bottom:1px solid var(--line);font-weight:800}
    tbody td{padding:10px;border-top:1px solid var(--line);vertical-align:top}
    tbody tr:nth-child(even){background:#fcfdff}
    .nowrap{white-space:nowrap}
    .files a{display:inline-block;margin:0 0 6px 8px;text-decoration:underline}
    .ok{padding:10px;background:#e9f9f2;border:1px solid #c7f0df;border-radius:10px;color:#0a7f48}
    .error{padding:10px;background:#ffecec;border:1px solid #ffc9c9;border-radius:10px;color:#7a0d0d}
    .grade-input{width:90px;padding:6px;border:1px solid #d9dee6;border-radius:8px}
    .fb-input{width:100%;min-width:220px;padding:6px;border:1px solid #d9dee6;border-radius:8px;resize:vertical}
    .rubric{margin-top:8px;background:#f9fbff;border:1px dashed #cfe0ff;border-radius:8px;padding:8px}
    .rubric h4{margin:0 0 6px;font-size:16px}
    .rubric table{border:1px solid #dbe3ed;margin-top:6px}
    footer{margin:30px auto 40px;text-align:center;color:#555;border-top:1px solid var(--line);padding:14px;max-width:1200px}
    #debugPanel{direction:ltr}
    #debugOut{white-space:pre-wrap;max-height:260px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</h1>
      <div class="top-actions">
        <button class="btn danger" onclick="deleteToken()">××—×§ Token ğŸ—‘ï¸</button>
        <button class="btn secondary" id="dbgToggle" onclick="toggleDebug()">××¦×‘ ×“×™×‘×•×’: ×›×‘×•×™</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="loginScreen" class="card">
      <h2 class="section-title">×”×ª×—×‘×¨×•×ª ×¢× Token</h2>
      <p class="muted">×”-Token × ×©××¨ ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ (localStorage). ×”×©×“×” ××•×¡×ª×¨ ×œ×¦×•×¨×š ×¤×¨×˜×™×•×ª.</p>
      <input type="password" id="tokenInput" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”-Token" style="width:60%">
      <div style="margin-top:10px"><button class="btn" onclick="saveToken()">×©××•×¨ ×•×”×ª×—×‘×¨</button></div>
    </div>
    <div id="mainScreen" class="hidden">
      <div id="submissions" class="card hidden">
        <h3 class="section-title" id="subsTitle">×”×’×©×•×ª</h3>
        <div id="subsArea"></div>
        <div id="subsMsg" class="ok hidden" style="margin-top:10px"></div>
        <div id="subsErr" class="error hidden" style="margin-top:10px"></div>
      </div>
      <details id="debugPanel" class="card hidden">
        <summary><strong>Debug</strong></summary>
        <pre id="debugOut"></pre>
      </details>
    </div>
    <footer>×¤×•×ª×— ×¢"×™ ×“"×¨ × ×™×¦×Ÿ ××œ×™×§×™× | ×¡×‘×™×‘×ª Vibe Coding</footer>
  </div>

<script>
  let token = localStorage.getItem("moodleToken") || "";
  const byId=(id)=>document.getElementById(id);
  let DEBUG=false;
  function toggleDebug(){ DEBUG=!DEBUG; byId('dbgToggle').textContent = `××¦×‘ ×“×™×‘×•×’: ${DEBUG?"×¤×•×¢×œ":"×›×‘×•×™"}`; byId('debugPanel').classList.toggle('hidden', !DEBUG); }
  function debugLog(tag,payload){ if(!DEBUG) return; const out=byId('debugOut'); const ts=new Date().toISOString(); out.textContent +=`\n[${ts}] ${tag}:\n`+JSON.stringify(payload,null,2)+"\n"; out.scrollTop=out.scrollHeight; }
  function saveToken(){ token=byId("tokenInput").value.trim(); if(!token){alert("× × ×œ×”×–×™×Ÿ Token");return;} localStorage.setItem("moodleToken",token); init(); }
  function deleteToken(){ localStorage.removeItem("moodleToken"); location.reload(); }

  async function apiCall(wsfunction, params={}){
    const q=new URLSearchParams({wstoken:token,wsfunction,moodlewsrestformat:"json"});
    for(const [k,v] of Object.entries(params)) q.append(k,v);
    const url=`https://moodle4.talpiot.ac.il/webservice/rest/server.php?${q.toString()}`;
    debugLog("REQUEST",{wsfunction,url,params});
    const res=await fetch(url);
    const text=await res.text();
    let data; try{data=JSON.parse(text);}catch{data={raw:text}};
    debugLog("RESPONSE",{wsfunction,data});
    if(data && (data.exception||data.errorcode)) throw new Error(data.message||data.errorcode);
    return data;
  }

  function fileUrlWithToken(rawUrl){
    if(!rawUrl) return "#";
    let url=rawUrl.replace("/pluginfile.php/","/webservice/pluginfile.php/");
    if(!url.includes("token=")) url+=(url.includes("?")?"&":"?")+"token="+encodeURIComponent(token);
    return url;
  }

  async function updateGrade(assignId, userId){
    const inp=byId(`g_${userId}`);
    const fb=byId(`fb_${userId}`);
    const gradeVal=(inp?.value||'').trim();
    const fbText=(fb?.value||'').trim();
    try{
      let fbPluginType="comments";
      const fbData=await apiCall('mod_assign_get_submission_status',{assignid:assignId,userid:userId});
      const plugins=fbData?.feedback?.plugins||[];
      const p=plugins.find(p=>p.type==="comments"||/comments/i.test(p.name||""));
      if(p) fbPluginType=p.type;
      const params={assignmentid:assignId,userid:userId,attemptnumber:-1,workflowstate:'graded',addattempt:0,applytoall:0};
      if(fbText!==''){
        params[`plugindata[${fbPluginType}][text]`]=fbText;
        params[`plugindata[${fbPluginType}][format]`]=1;
        params[`plugindata[${fbPluginType}][itemid]`]=0;
      }
      if(gradeVal!=='') params.grade=gradeVal;
      debugLog('SAVE_GRADE_PARAMS',params);
      const resp=await apiCall('mod_assign_save_grade',params);
      debugLog('SAVE_GRADE_RESP',resp);
      byId('subsMsg').textContent='×”×¦×™×•×Ÿ/××©×•×‘ ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”.';
      byId('subsMsg').classList.remove('hidden');
    }catch(e){ debugLog('SAVE_GRADE_ERROR',{message:e.message}); alert('×¢×“×›×•×Ÿ × ×›×©×œ: '+e.message); }
  }
</script>
</body>
</html>
