<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>מכללת תלפיות - שליפת מידע מהמוודל</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:"Segoe UI","Rubik",Tahoma,Arial,sans-serif;background:#f5f7fb;margin:0;color:#1f2937}
    header{background:#0b4d88;color:#fff;padding:20px}
    h1{margin:0;font-size:22px}
    .container{max-width:1200px;margin:auto;padding:18px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:16px}
    .pillbar{display:flex;flex-wrap:wrap;gap:10px}
    .pill{border:1px solid #ccc;background:#eef2f7;padding:8px 12px;border-radius:999px;cursor:pointer}
    .pill.selected{background:#0d63b5;color:#fff}
    table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:right;vertical-align:top}
    th{background:#f0f4f8}
    .files a{display:block;margin:2px 0;color:#0b4d88;text-decoration:underline}
    .grade-input{width:70px}
    .fb-input{width:100%;min-width:200px}
    .ok{padding:10px;background:#e9f9f2;border:1px solid #c7f0df;border-radius:10px;color:#0a7f48;margin-top:10px}
    .error{padding:10px;background:#ffecec;border:1px solid #ffc9c9;border-radius:10px;color:#7a0d0d;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <h1>מכללת תלפיות - שליפת מידע מהמוודל</h1>
  </header>

  <div class="container">
    <div id="loginScreen" class="card">
      <h2>התחברות עם Token</h2>
      <input type="password" id="tokenInput" placeholder="הדבק כאן את ה-Token" style="width:60%">
      <button onclick="saveToken()">שמור</button>
    </div>

    <div id="mainScreen" class="hidden">
      <div id="years" class="card">
        <h3>שנות לימוד</h3>
        <div id="yearsBar" class="pillbar"></div>
      </div>
      <div id="semesters" class="card hidden">
        <h3>סמסטרים</h3>
        <div id="semsBar" class="pillbar"></div>
      </div>
      <div id="courses" class="card hidden">
        <h3>קורסים</h3>
        <div id="coursesBar" class="pillbar"></div>
      </div>
      <div id="assignments" class="card hidden">
        <h3>מטלות</h3>
        <div id="assignList"></div>
      </div>
      <div id="submissions" class="card hidden">
        <h3 id="subsTitle">הגשות</h3>
        <div id="subsArea"></div>
        <div id="subsMsg" class="ok hidden"></div>
        <div id="subsErr" class="error hidden"></div>
      </div>
    </div>
  </div>

<script>
const baseUrl="https://moodle4.talpiot.ac.il";
let token=localStorage.getItem("moodleToken")||"";

function log(msg,obj){console.log("[LOG]",msg,obj||"");}

function saveToken(){token=document.getElementById("tokenInput").value.trim();if(!token)return;localStorage.setItem("moodleToken",token);init();}
function deleteToken(){localStorage.removeItem("moodleToken");location.reload();}

async function apiCall(wsfunction,params={}){
  const q=new URLSearchParams({wstoken:token,wsfunction,moodlewsrestformat:"json"});
  for(const[k,v]of Object.entries(params))q.append(k,v);
  const url=`${baseUrl}/webservice/rest/server.php?${q}`;
  log("API CALL",{wsfunction,url,params});
  const res=await fetch(url);
  const d=await res.json();
  log("API RESP",d);
  if(d.exception||d.errorcode)throw new Error(d.message);
  return d;
}

function fileUrl(f){
  if(!f.fileurl)return"";
  let u=f.fileurl;
  if(u.includes("/pluginfile.php")){
    u=u.replace("/pluginfile.php","/webservice/pluginfile.php");
  }
  if(!u.includes("token=")){
    u+=(u.includes("?")?"&":"?")+"token="+token;
  }
  return u;
}

function cleanHtml(html){if(!html)return"";return html.replace(/<[^>]+>/g,"\n").trim();}

async function updateGrade(aid,uid){
  const grade=document.getElementById(`g_${uid}`).value;
  const fb=document.getElementById(`fb_${uid}`).value;
  const params={assignmentid:aid,userid:uid,attemptnumber:-1,workflowstate:"graded",addattempt:0,applytoall:0,grade:grade,"plugindata[assignfeedbackcomments_editor][text]":fb,"plugindata[assignfeedbackcomments_editor][format]":1,"plugindata[assignfeedbackcomments_editor][itemid]":0};
  log("UPDATE GRADE",params);
  try{const res=await apiCall("mod_assign_save_grade",params);log("UPDATE SUCCESS",res);alert("עודכן בהצלחה");}catch(e){console.error(e);alert("שגיאה: "+e.message);}
}
</script>
</body>
</html>
