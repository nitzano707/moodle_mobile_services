<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#0b4d88;--accent:#0d63b5;--accent2:#0b58a4;--light:#f5f7fb;--card:#ffffff;--muted:#6b7280;--line:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--light);color:#1f2937;font-family:"Segoe UI","Rubik",Tahoma,Arial,sans-serif}
    header{background:var(--blue);color:#fff;padding:22px 16px}
    header .wrap{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{margin:0;font-size:clamp(18px,2.6vw,28px)}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tabbtn{appearance:none;border:1px solid #d4dbe6;background:#e8eef6;color:#0b2743;padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer}
    .tabbtn.active{background:#fff;border-color:#d4dbe6}
    .danger{background:#ffe8e8;color:#7a0d0d;border-color:#ffd1d1}
    .container{max-width:1200px;margin:auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .section-title{margin:0 0 10px;font-size:19px}
    .hidden{display:none}
    .muted{color:var(--muted)}
    .pillbar{display:flex;flex-wrap:wrap;gap:10px}
    .pill{border:1px solid #dbe3ed;background:#eef2f7;padding:9px 13px;border-radius:999px;cursor:pointer;font-weight:600;transition:all 0.2s ease;}
    .pill.selected{background:var(--accent);color:#fff;border-color:#0a4c8a;box-shadow:0 2px 4px rgba(11,77,136,0.3);}
    .crumbs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .crumb{background:#f1f5fb;border:1px solid #dbe3ed;border-radius:999px;padding:6px 10px}
    .btn{appearance:none;border:1px solid #ccd6e4;background:var(--accent);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;transition:all 0.2s ease;}
    .btn:hover{background:var(--accent2)}
    .btn.secondary{background:#eef3f9;color:#0b2743;border-color:#d4dbe6}
    .btn.secondary.selected{background:var(--accent);color:#fff;border-color:#0a4c8a;}
    .assignBtn.selected{background:var(--accent);color:#fff;border-color:#0a4c8a;}
    table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:right;vertical-align:top}
    th{background:#f0f4f8}
    tbody tr:nth-child(even){background:#f9fafb}
    .nowrap{white-space:nowrap}
    .files a{display:block;margin:2px 0;text-decoration:underline}
    .ok{padding:10px;background:#e9f9f2;border:1px solid #c7f0df;border-radius:10px;color:#0a7f48;margin-top:10px}
    .error{padding:10px;background:#ffecec;border:1px solid #ffc9c9;border-radius:10px;color:#7a0d0d;margin-top:10px}
    .floating-message{position:fixed;top:20px;right:20px;z-index:1000;background:#4caf50;color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:translateY(-100px);opacity:0;transition:all 0.3s ease;}
    .floating-message.show{transform:translateY(0);opacity:1;}
    .floating-message.error{background:#f44336;}
    .grade-input{width:70px;padding:6px;border:1px solid #d9dee6;border-radius:8px}
    .fb-input{width:100%;min-width:200px;padding:6px;border:1px solid #d9dee6;border-radius:8px}
    .rubric{margin-top:8px;background:#f9fbff;border:1px dashed #cfe0ff;border-radius:8px;padding:8px}
    footer{margin:30px auto 40px;text-align:center;color:#555;border-top:1px solid var(--line);padding:14px;max-width:1200px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</h1>
      <div class="top-actions">
        <button id="navHier" class="tabbtn active" onclick="showTab('hierarchy')">×××©×§ ×”×™×¨×¨×›×™ ğŸ“š</button>
        <button id="navFuncs" class="tabbtn" onclick="showTab('functions')">×¤×•× ×§×¦×™×•×ª ×–××™× ×•×ª âš™ï¸</button>
        <button class="tabbtn danger" id="deleteTokenBtn" onclick="deleteToken()" style="display:none;">××—×§ Token ğŸ—‘ï¸</button>
      </div>
    </div>
  </header>

  <div class="container">

    <!-- Login -->
    <div id="loginScreen" class="card">
      <h2 class="section-title">×”×ª×—×‘×¨×•×ª ×¢× Token</h2>
      <p class="muted">×”-Token × ×©××¨ ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ (localStorage). ×”×©×“×” ××•×¡×ª×¨ ×œ×¦×•×¨×š ×¤×¨×˜×™×•×ª.</p>
      <input type="password" id="tokenInput" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”-Token" style="width:60%" />
      <div style="margin-top:10px"><button class="btn" onclick="saveToken()">×©××•×¨ ×•×”×ª×—×‘×¨</button></div>
    </div>

    <!-- Main -->
    <div id="mainScreen" class="hidden">

      <!-- Breadcrumb selections -->
      <div id="crumbsBox" class="card hidden">
        <div class="crumbs">
          <div id="crumbYear" class="crumb hidden"></div>
          <div id="crumbSem" class="crumb hidden"></div>
          <div id="crumbCourse" class="crumb hidden"></div>
          <div id="crumbAssign" class="crumb hidden"></div>
          <button class="btn secondary" onclick="resetSelections()">× ×§×” ×‘×—×™×¨×•×ª</button>
        </div>
      </div>

      <!-- HIERARCHY -->
      <div id="hierarchyTab" class="tab">
        <div id="years" class="card">
          <h3 class="section-title">×©× ×•×ª ×œ×™××•×“</h3>
          <div id="yearsBar" class="pillbar"></div>
          <div id="yearsEmpty" class="muted hidden">×œ× × ××¦××• ×©× ×™×</div>
        </div>

        <div id="semesters" class="card hidden">
          <h3 class="section-title">×¡××¡×˜×¨×™×</h3>
          <div id="semsBar" class="pillbar"></div>
        </div>

        <div id="courses" class="card hidden">
          <h3 class="section-title">×§×•×¨×¡×™×</h3>
          <div id="coursesBar" class="pillbar"></div>
        </div>

        <div id="assignments" class="card hidden">
          <h3 class="section-title">××˜×œ×•×ª</h3>
          <div id="assignList"></div>
        </div>

        <div id="submissions" class="card hidden">
          <h3 class="section-title" id="subsTitle">×”×’×©×•×ª</h3>
          <div id="subsArea"></div>
          <div id="subsMsg" class="ok hidden" style="margin-top:10px"></div>
          <div id="subsErr" class="error hidden" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- FUNCTIONS -->
      <div id="functionsTab" class="tab hidden">
        <div class="card">
          <h3 class="section-title">×›×œ ×”×¤×•× ×§×¦×™×•×ª ×”×–××™× ×•×ª ×‘×˜×•×§×Ÿ</h3>
          <div id="funcsBar" class="pillbar"></div>
          <pre id="funcResult" class="card" style="white-space:pre-wrap;overflow:auto;max-height:420px"></pre>
        </div>
      </div>
    </div>

    <footer>×¤×•×ª×— ×¢"×™ ×“"×¨ × ×™×¦×Ÿ ××œ×™×§×™× | ×¡×‘×™×‘×ª Vibe Coding</footer>
  </div>

<script>
  // ======= CONFIG & STATE =======
  const baseUrl = "https://moodle4.talpiot.ac.il";
  let token = localStorage.getItem("moodleToken") || "";

  const state = {
    me: null,
    courses: [],
    selectedYear: null,
    selectedSem: null,
    selectedCourse: null,
    enrolled: new Map(), // courseId -> [users]
    assignId: null,
    assignName: ""
  };

  // ======= BOOT =======
  window.addEventListener("load", () => { if (token) init(); });

  function saveToken(){
    token = document.getElementById("tokenInput").value.trim();
    if(!token){ alert("× × ×œ×”×–×™×Ÿ Token"); return; }
    localStorage.setItem("moodleToken", token);
    document.getElementById("deleteTokenBtn").style.display = "block";
    init();
  }
  
  function deleteToken(){
    localStorage.removeItem("moodleToken");
    location.reload();
  }
  
  function showTab(which){
    const tabs = { hierarchy: "hierarchyTab", functions: "functionsTab" };
    for (const k in tabs) document.getElementById(tabs[k]).classList.toggle("hidden", k!==which);
    document.getElementById("navHier").classList.toggle("active", which==="hierarchy");
    document.getElementById("navFuncs").classList.toggle("active", which==="functions");
  }

  // ======= API =======
  async function apiCall(wsfunction, params={}){
    const q = new URLSearchParams({ wstoken: token, wsfunction, moodlewsrestformat: "json" });
    for (const [k,v] of Object.entries(params)) q.append(k, v);
    const url = `${baseUrl}/webservice/rest/server.php?${q.toString()}`;
    const res = await fetch(url);
    const data = await res.json();
    
    // ×‘×“×™×§×” ×™×•×ª×¨ ×—×›××” ×©×œ ×”×ª×’×•×‘×”
    if(data && (data.exception||data.errorcode)) {
      throw new Error(data.message||data.debuginfo||"API Error");
    }
    
    // ×× ×”×ª×’×•×‘×” null ××• undefined, ×–×” ××•××¨ ×‘×“×¨×š ×›×œ×œ ×©×”×¤×¢×•×œ×” ×”×¦×œ×™×—×”
    if(data === null || data === undefined) {
      return {};
    }
    
    return data;
  }
  
  const fmtDate = (ts) => ts ? new Date(ts*1000).toLocaleString() : "â€“";
  const fmtGrade = (g) => (g==null || g==="") ? "â€“" : (Number.isFinite(+g) ? String(Math.round(+g)) : String(g).replace(/\.0+$/,''));
  const escapeHtml = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

  // ======= YEAR / SEM DETECTION =======
  function detectYearLabel(name){
    if (!name) return "×œ× ×™×“×•×¢";
    const heb = name.match(/×ª×©×¤.?[\"×´×³']?[××‘×’×“×”×•×–×—×˜×™×›×œ×× ×¡×¢×¤×¦×§×¨×©×ª]?/);
    if (heb) return heb[0].replace(/\"|×´|×³|'/g,"");
    const g = name.match(/20\d{2}/);
    return g ? g[0] : "×œ× ×™×“×•×¢";
  }
  
  function detectSemesterLabel(name){
    if(!name) return "×œ× ××•×’×“×¨";
    if (/×¡××¡×˜×¨.?×/.test(name)) return "×¡××¡×˜×¨ ×";
    if (/×¡××¡×˜×¨.?×‘/.test(name)) return "×¡××¡×˜×¨ ×‘";
    if (/×¡××¡×˜×¨.?×§/.test(name) || /×§×™×¥/.test(name)) return "×¡××¡×˜×¨ ×§";
    if (/×¡××¡×˜×¨.?×©/.test(name) || /×©× ×ª×™/.test(name)) return "×¡××¡×˜×¨ ×©";
    return "×œ× ××•×’×“×¨";
  }

  // ======= INIT =======
  async function init(){
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("mainScreen").classList.remove("hidden");
    document.getElementById("deleteTokenBtn").style.display = "block";
    showTab("hierarchy");
    resetSelections(true);

    try{
      state.me = await apiCall("core_webservice_get_site_info");
      state.courses = await apiCall("core_enrol_get_users_courses", { userid: state.me.userid });
      renderYears();
      buildFunctionsTab();
    }catch(e){
      alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: " + e.message);
      deleteToken();
    }
  }

  // ======= FUNCTIONS TAB =======
  async function buildFunctionsTab(){
    const funcs = state.me.functions || [];
    const bar = document.getElementById("funcsBar");
    bar.innerHTML = "";
    document.getElementById("funcResult").textContent = "";
    funcs.forEach(f=>{
      const b = document.createElement("button");
      b.className = "pill";
      b.textContent = f.name;
      b.onclick = async ()=>{
        document.querySelectorAll("#funcsBar .pill").forEach(p=>p.classList.remove("selected"));
        b.classList.add("selected");
        document.getElementById("funcResult").textContent = "×˜×•×¢×Ÿ...";
        try{
          const data = await apiCall(f.name);
          document.getElementById("funcResult").textContent = JSON.stringify(data,null,2);
        }catch(err){
          document.getElementById("funcResult").textContent = "×©×’×™××”: " + err.message;
        }
      };
      bar.appendChild(b);
    });
  }

  // ======= HIERARCHY FLOW =======
  function resetSelections(skipRenderCrumbs=false){
    state.selectedYear = null;
    state.selectedSem = null;
    state.selectedCourse = null;
    state.assignId = null;
    state.assignName = "";
    if (!skipRenderCrumbs) renderCrumbs();
    
    // ×”×¡×¨ ×”×“×’×©×•×ª ××›×œ ×”×›×¤×ª×•×¨×™×
    document.querySelectorAll(".pill.selected, .btn.selected, .assignBtn.selected").forEach(el => el.classList.remove("selected"));
    
    document.getElementById("semesters").classList.add("hidden");
    document.getElementById("courses").classList.add("hidden");
    document.getElementById("assignments").classList.add("hidden");
    document.getElementById("submissions").classList.add("hidden");
  }
  
  function renderCrumbs(){
    const box = document.getElementById("crumbsBox");
    const year = document.getElementById("crumbYear");
    const sem = document.getElementById("crumbSem");
    const course = document.getElementById("crumbCourse");
    const assign = document.getElementById("crumbAssign");
    let any = false;

    if (state.selectedYear){ year.textContent = "×©× ×”: " + state.selectedYear; year.classList.remove("hidden"); any = true; } else year.classList.add("hidden");
    if (state.selectedSem){ sem.textContent = "×¡××¡×˜×¨: " + state.selectedSem; sem.classList.remove("hidden"); any = true; } else sem.classList.add("hidden");
    if (state.selectedCourse){ course.textContent = "×§×•×¨×¡: " + (state.selectedCourse.fullname || state.selectedCourse.shortname); course.classList.remove("hidden"); any = true; } else course.classList.add("hidden");
    if (state.assignId){ assign.textContent = "××˜×œ×”: " + state.assignName; assign.classList.remove("hidden"); any = true; } else assign.classList.add("hidden");

    box.classList.toggle("hidden", !any);
  }

  function renderYears(){
    const yearsBar = document.getElementById("yearsBar");
    const yearsEmpty = document.getElementById("yearsEmpty");
    yearsBar.innerHTML = "";
    const groups = new Map();
    state.courses.forEach(c=>{
      const y = detectYearLabel(c.fullname || c.shortname || "");
      if(!groups.has(y)) groups.set(y,[]);
      groups.get(y).push(c);
    });
    const years = Array.from(groups.keys()).sort((a,b)=> String(b).localeCompare(String(a), 'he'));
    if (years.length===0){ yearsEmpty.classList.remove("hidden"); return; }
    yearsEmpty.classList.add("hidden");

    years.forEach(y=>{
      const btn = document.createElement("button");
      btn.className = "pill";
      btn.textContent = y;
      btn.onclick = ()=> {
        state.selectedYear = y;
        renderCrumbs();
        document.querySelectorAll("#yearsBar .pill").forEach(p=>p.classList.remove("selected"));
        btn.classList.add("selected");
        renderSemesters(groups.get(y));
      };
      yearsBar.appendChild(btn);
    });
  }

  function renderSemesters(courses){
    document.getElementById("semesters").classList.remove("hidden");
    document.getElementById("courses").classList.add("hidden");
    document.getElementById("assignments").classList.add("hidden");
    document.getElementById("submissions").classList.add("hidden");
    const semBar = document.getElementById("semsBar");
    semBar.innerHTML = "";

    const order = ["×¡××¡×˜×¨ ×","×¡××¡×˜×¨ ×‘","×¡××¡×˜×¨ ×§","×¡××¡×˜×¨ ×©","×œ× ××•×’×“×¨"];
    const semGroups = new Map(order.map(s=>[s, []]));
    courses.forEach(c=>{
      const s = detectSemesterLabel(c.fullname || c.shortname || "");
      semGroups.get(s ?? "×œ× ××•×’×“×¨").push(c);
    });

    order.forEach(s=>{
      if (!semGroups.get(s) || semGroups.get(s).length===0) return;
      const btn = document.createElement("button");
      btn.className = "pill";
      btn.textContent = s;
      btn.onclick = ()=> {
        state.selectedSem = s;
        renderCrumbs();
        document.querySelectorAll("#semsBar .pill").forEach(p=>p.classList.remove("selected"));
        btn.classList.add("selected");
        renderCourses(semGroups.get(s));
      };
      semBar.appendChild(btn);
    });
  }

  function renderCourses(courses){
    const bar = document.getElementById("coursesBar");
    bar.innerHTML = "";
    document.getElementById("courses").classList.remove("hidden");
    document.getElementById("assignments").classList.add("hidden");
    document.getElementById("submissions").classList.add("hidden");

    courses.forEach(c=>{
      const btn = document.createElement("button");
      btn.className = "pill";
      btn.textContent = c.fullname || c.shortname || ("×§×•×¨×¡ " + c.id);
      btn.onclick = ()=> {
        state.selectedCourse = c;
        renderCrumbs();
        document.querySelectorAll("#coursesBar .pill").forEach(p=>p.classList.remove("selected"));
        btn.classList.add("selected");
        openCourse(c);
      };
      bar.appendChild(btn);
    });
  }

  async function openCourse(course){
    document.getElementById("assignList").innerHTML = "<div class='muted'>×˜×•×¢×Ÿ ××˜×œ×•×ªâ€¦</div>";
    document.getElementById("assignments").classList.remove("hidden");
    document.getElementById("submissions").classList.add("hidden");

    // cache enrolled users (for names)
    if (!state.enrolled.has(course.id)){
      try{
        const users = await apiCall("core_enrol_get_enrolled_users", { courseid: course.id });
        state.enrolled.set(course.id, users || []);
      }catch(e){ state.enrolled.set(course.id, []); }
    }

    try{
      const data = await apiCall("mod_assign_get_assignments", {"courseids[0]": course.id});
      const assigns = (data.courses && data.courses[0]) ? data.courses[0].assignments : [];
      if(assigns.length===0){
        document.getElementById("assignList").innerHTML = "<div class='muted'>××™×Ÿ ××˜×œ×•×ª ×‘×§×•×¨×¡ ×–×”</div>";
        return;
      }
      let html = "<table><thead><tr><th>×©× ××˜×œ×”</th><th class='nowrap'>×¤×ª×™×—×”</th><th class='nowrap'>×“×“×œ×™×™×Ÿ</th></tr></thead><tbody>";
      assigns.forEach(a=>{
        html += `<tr>
          <td><button class="btn secondary assignBtn" data-assign-id="${a.id}" onclick="loadSubs(${a.id}, '${a.name.replace(/'/g, "\\'")}')">${a.name}</button></td>
          <td class="nowrap">${fmtDate(a.allowsubmissionsfromdate)}</td>
          <td class="nowrap">${fmtDate(a.duedate)}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById("assignList").innerHTML = html;
    }catch(e){
      document.getElementById("assignList").innerHTML = `<div class="error">×©×’×™××” ×‘×˜×¢×™× ×ª ××˜×œ×•×ª: ${e.message}</div>`;
    }
  }

  function markSelectedAssignment(assignId){
    document.querySelectorAll(".assignBtn").forEach(b=>b.classList.remove("selected"));
    const el = document.querySelector(`.assignBtn[data-assign-id='${assignId}']`);
    if (el) el.classList.add("selected");
  }

  // ======= ASSIGNMENT DETAILS & RUBRIC =======
  async function getAssignmentDetails(assignmentId) {
    try {
      const assignData = await apiCall("mod_assign_get_assignments", {"courseids[0]": state.selectedCourse.id});
      const assignment = assignData.courses?.[0]?.assignments?.find(a => a.id == assignmentId);
      
      if (!assignment) return { intro: "", rubric: [] };

      console.log("Assignment details:", assignment);

      // ×¨×§ ×”×—×–×¨×ª ×”× ×—×™×•×ª ×”××˜×œ×” - ×œ× × ×™×¦×•×¨ ××—×•×•×Ÿ ××œ××›×•×ª×™
      return {
        intro: assignment.intro || assignment.description || "",
        rubric: [] // × ×©××™×¨ ×¨×™×§ ×¢×“ ×©× ××¦× ××™×“×¢ ×××™×ª×™ ×¢×œ ××—×•×•×Ÿ
      };
      
    } catch (e) {
      console.error("Error getting assignment details:", e);
      return { intro: "", rubric: [] };
    }
  }

  async function getRubricFeedback(assignmentId, userId) {
    try {
      const status = await apiCall("mod_assign_get_submission_status", {
        assignid: assignmentId,
        userid: userId
      });

      const rubricData = {};
      const plugins = status?.feedback?.plugins || [];
      
      console.log(`Full status for user ${userId}:`, JSON.stringify(status, null, 2));
      
      // ×—×¤×© ×‘×›×œ ×”×¤×œ××’×™× ×™× ×•×‘×›×œ ×”×©×“×•×ª
      plugins.forEach((plugin, pluginIndex) => {
        console.log(`Plugin ${pluginIndex} for user ${userId}:`, plugin.type, plugin);
        
        // ×‘×“×•×§ ×›×œ ×”×©×“×•×ª ×©×œ ×”×¤×œ××’×™×Ÿ
        Object.keys(plugin).forEach(key => {
          const value = plugin[key];
          if (key.includes('criteri') || key.includes('rubric') || key.includes('grade')) {
            console.log(`Potential rubric data in plugin ${pluginIndex}.${key}:`, value);
          }
        });
      });
      
      // ×—×¤×© ×’× ×‘×©×“×•×ª ××—×¨×™× ×©×œ ×”×¡×˜×˜×•×¡
      Object.keys(status || {}).forEach(key => {
        const value = status[key];
        if (key.includes('criteri') || key.includes('rubric') || key.includes('grade')) {
          console.log(`Potential rubric data in status.${key}:`, value);
        }
      });

      return rubricData;
    } catch (e) {
      console.error(`Error getting rubric feedback for user ${userId}:`, e);
      return {};
    }
  }

  // ======= FEEDBACK =======
  async function getFeedback(aid,uid){
    try{
      const st = await apiCall("mod_assign_get_submission_status",{assignid:aid,userid:uid});
      const plugins = st?.feedback?.plugins || [];
      for(const p of plugins){
        if(p.type==="comments"&&p.editorfields){
          return p.editorfields[0]?.text || "";
        }
      }
      return "";
    }catch{return "";}
  }

  // ======= LOAD SUBMISSIONS =======
  async function loadSubs(aid,name){
    state.assignId=aid;state.assignName=name;
    document.getElementById("subsTitle").textContent="×”×’×©×•×ª ×‘××˜×œ×”: "+name;
    document.getElementById("submissions").classList.remove("hidden");
    document.getElementById("subsArea").innerHTML="×˜×•×¢×Ÿ...";
    document.getElementById("subsMsg").classList.add("hidden");
    document.getElementById("subsErr").classList.add("hidden");
    markSelectedAssignment(aid);
    
    try{
      // ×§×‘×œ×ª ×¤×¨×˜×™ ×”××˜×œ×” ×›×•×œ×œ ×”× ×—×™×•×ª ×•××—×•×•×Ÿ
      const assignmentDetails = await getAssignmentDetails(aid);
      
      const [subs,grades]=await Promise.all([
        apiCall("mod_assign_get_submissions",{"assignmentids[0]":aid}),
        apiCall("mod_assign_get_grades",{"assignmentids[0]":aid})
      ]);
      const submissions=subs.assignments[0]?.submissions||[];
      const gradesMap=new Map();(grades.assignments[0]?.grades||[]).forEach(g=>gradesMap.set(g.userid,g));
      const users=state.enrolled.get(state.selectedCourse.id)||[];

      // ×‘× ×™×™×ª HTML ×¢×‘×•×¨ ×”× ×—×™×•×ª ×”××˜×œ×”
      let assignmentInfoHtml = "";
      if(assignmentDetails.intro) {
        assignmentInfoHtml = `<div class="card" style="background:#f8f9ff;border-color:#d4dbe6;margin-bottom:16px;">
          <h4 style="margin:0 0 10px 0;">×”× ×—×™×•×ª ×”××˜×œ×”:</h4>
          <div style="border:1px solid #e5e7eb;padding:12px;border-radius:8px;background:white;">
            ${assignmentDetails.intro}
          </div>
        </div>`;
      }

      // ×‘× ×™×™×ª HTML ×¢×‘×•×¨ ××—×•×•×Ÿ (×× ×§×™×™×) - ×¨×§ ×× ×™×© ×§×¨×™×˜×¨×™×•× ×™×
      let rubricHtml = "";
      const rubricCriteria = assignmentDetails.rubric || [];
      
      if(rubricCriteria.length > 0) {
        rubricHtml = `<div class="card" style="background:#fff8f0;border-color:#e6ddd4;margin-bottom:16px;">
          <h4 style="margin:0 0 10px 0;">××—×•×•×Ÿ ×”×¢×¨×›×”:</h4>
          <table style="margin-top:10px;">
            <thead>
              <tr>
                <th>×§×¨×™×˜×¨×™×•×Ÿ</th>
                <th>×ª×™××•×¨</th>
                <th>× ×™×§×•×“ ××§×¡×™××œ×™</th>
              </tr>
            </thead>
            <tbody>`;
        
        rubricCriteria.forEach(criterion => {
          rubricHtml += `
            <tr>
              <td><strong>${criterion.shortname || '×§×¨×™×˜×¨×™×•×Ÿ'}</strong></td>
              <td>${criterion.description || ''}</td>
              <td>${criterion.maxscore}</td>
            </tr>`;
        });
        
        rubricHtml += `</tbody></table></div>`;
      }

      // ×‘× ×™×™×ª ×›×•×ª×¨×•×ª ×”×˜×‘×œ×”
      let tableHeaders = "<thead><tr><th>×¡×˜×•×“× ×˜</th><th>×§×‘×¦×™×</th><th>×¦×™×•×Ÿ ×›×œ×œ×™</th>";
      
      // ×”×•×¡×¤×ª ×¢××•×“×•×ª ×§×¨×™×˜×¨×™×•× ×™× ×× ×™×© ××—×•×•×Ÿ
      if(rubricCriteria.length > 0) {
        rubricCriteria.forEach(criterion => {
          tableHeaders += `<th style="min-width:140px;max-width:200px;">
            <div><strong>${criterion.shortname || '×§×¨×™×˜×¨×™×•×Ÿ'}</strong></div>
            <div class="muted" style="font-size:0.8em;font-weight:normal;">× ×™×§×•×“ ×•××©×•×‘</div>
          </th>`;
        });
      }
      
      tableHeaders += "<th>××©×•×‘ ×›×œ×œ×™</th><th>×¢×“×›×•×Ÿ</th></tr></thead>";

      // ×‘× ×™×™×ª ×©×•×¨×•×ª ×”×˜×‘×œ×”
      let tableRows = "<tbody>";
      
      for(const s of submissions){
        const u=users.find(x=>x.id===s.userid);
        const g=gradesMap.get(s.userid);
        const grade=fmtGrade(g?.grade);
        const fb=await getFeedback(aid,s.userid);
        
        // ×§×‘×œ×ª ×¤×¨×˜×™ ××—×•×•×Ÿ ×¢×‘×•×¨ ×”×¡×˜×•×“× ×˜ - ×¨×§ ×× ×™×© ×§×¨×™×˜×¨×™×•× ×™×
        let rubricFeedback = {};
        if(rubricCriteria.length > 0) {
          rubricFeedback = await getRubricFeedback(aid, s.userid);
        }
        
        const files=[];s.plugins?.forEach(p=>p.fileareas?.forEach(fa=>fa.files?.forEach(f=>{
          const url=f.fileurl.includes("token=")?f.fileurl:f.fileurl+"?token="+token;
          files.push(`<a href="${url}" target="_blank">${f.filename}</a>`);
        })));

        tableRows += `<tr>
          <td>
            <div><strong>${u?.fullname||s.userid}</strong></div>
            <div class="muted" style="font-size:0.85em;">${u?.email||`ID: ${s.userid}`}</div>
          </td>
          <td class="files">${files.join("<br>")||"<span class='muted'>â€”</span>"}</td>
          <td style="text-align:center;"><strong>${grade}</strong></td>`;

        // ×”×•×¡×¤×ª ×¢××•×“×•×ª ×§×¨×™×˜×¨×™×•× ×™× - ×¨×§ ×× ×™×© ××—×•×•×Ÿ
        if(rubricCriteria.length > 0) {
          rubricCriteria.forEach(criterion => {
            const criterionId = criterion.id;
            const criterionData = rubricFeedback[criterionId] || {};
            const score = criterionData.score || 'â€”';
            const remark = criterionData.remark || '';
            
            tableRows += `<td style="font-size:0.9em;vertical-align:top;border-left:2px solid #e3f2fd;padding:8px;">
              <div style="margin-bottom:6px;">
                <strong style="color:#1976d2;font-size:1em;">× ×™×§×•×“: ${score}</strong>
                ${criterion.maxscore ? `<span class="muted" style="font-size:0.8em;"> / ${criterion.maxscore}</span>` : ''}
              </div>
              <div style="border-top:1px dashed #ddd;padding-top:4px;">
                <textarea id="rubric_${s.userid}_${criterionId}" 
                          style="width:100%;min-height:50px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:0.85em;resize:vertical;" 
                          placeholder="××©×•×‘ ×œ×§×¨×™×˜×¨×™×•×Ÿ ×–×”...">${remark}</textarea>
              </div>
            </td>`;
          });
        }

        tableRows += `
          <td><textarea id="fb_${s.userid}" class="fb-input" rows="2" placeholder="××©×•×‘ ×›×œ×œ×™ ×œ××˜×œ×”...">${fb}</textarea></td>
          <td class="nowrap">
            <div><input type="number" step="0.01" id="g_${s.userid}" class="grade-input" placeholder="${grade === 'â€“' ? '×¦×™×•×Ÿ' : ''}" value="${grade !== 'â€“' ? grade : ''}"></div>
            <div style="margin-top:4px;"><button class="btn secondary" onclick="updateGrade(${aid},${s.userid})">×©××•×¨</button></div>
          </td>
        </tr>`;
      }
      tableRows += "</tbody>";

      const finalHtml = assignmentInfoHtml + rubricHtml + `<table style="margin-top:10px;">${tableHeaders}${tableRows}</table>`;
      document.getElementById("subsArea").innerHTML = finalHtml;
      
    }catch(e){
      console.error("Error loading submissions:", e);
      document.getElementById("subsErr").textContent="×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×©×•×ª: " + e.message;
      document.getElementById("subsErr").classList.remove("hidden");
    }
  }

  // ======= UPDATE GRADE =======
  async function updateGrade(aid, uid) {
    const gradeInput = document.getElementById(`g_${uid}`);
    const fbInput = document.getElementById(`fb_${uid}`);
    const grade = gradeInput.value.trim();
    const fb = fbInput.value;
    
    try {
      console.log(`Updating grade for user ${uid}, grade: ${grade}`);
      
      // ××™×¡×•×£ ×›×œ ×”××©×•×‘ ×©×œ ×”×§×¨×™×˜×¨×™×•× ×™×
      const rubricFeedbacks = {};
      const rubricInputs = document.querySelectorAll(`[id^="rubric_${uid}_"]`);
      
      rubricInputs.forEach(input => {
        const match = input.id.match(/^rubric_\d+_(.+)$/);
        if (match) {
          const criterionId = match[1];
          rubricFeedbacks[criterionId] = input.value.trim();
          console.log(`Found rubric feedback for criterion ${criterionId}:`, input.value.trim());
        }
      });

      // ××©×ª××© ×‘×¤×¨××˜×¨×™× ×”× ×›×•× ×™× ×›××• ×‘×§×•×“ ×”×¢×•×‘×“
      const params = {
        assignmentid: aid,
        userid: uid,
        attemptnumber: -1,
        addattempt: 0,
        workflowstate: "graded",
        applytoall: 0,
        "plugindata[assignfeedbackcomments_editor][text]": fb || "",
        "plugindata[assignfeedbackcomments_editor][format]": 1
      };
      
      // ×”×•×¡×£ ×¦×™×•×Ÿ ×× ×§×™×™×
      if (grade !== "") {
        params.grade = grade;
      }

      // ×”×•×¡×£ ××©×•×‘ ×§×¨×™×˜×¨×™×•× ×™× ×× ×™×©
      if (Object.keys(rubricFeedbacks).length > 0) {
        Object.entries(rubricFeedbacks).forEach(([criterionId, feedback]) => {
          if (feedback) {
            // × × ×¡×” ×¤×•×¨××˜×™× ×©×•× ×™× ×œ××©×•×‘ ××—×•×•×Ÿ
            params[`advancedgradingdata[criteria][${criterionId}][remark]`] = feedback;
            params[`advancedgradingdata[guide][criteria][${criterionId}][remark]`] = feedback;
            params[`plugindata[gradingform_rubric][criterion_${criterionId}_remark]`] = feedback;
            params[`gradingform_rubric_instance_criterion_${criterionId}_remark`] = feedback;
          }
        });
        
        console.log("Added rubric feedback params:", Object.keys(params).filter(k => k.includes('criteria') || k.includes('rubric')));
      }
      
      console.log("API params:", params);
      
      // ×©××•×¨ ××ª ×”×¦×™×•×Ÿ ×•×”××©×•×‘
      const result = await apiCall("mod_assign_save_grade", params);
      console.log("Save grade result:", result);
      
      // ×”×¦×’ ×”×•×“×¢×” ××¨×—×¤×ª ×©×œ ×”×¦×œ×—×”
      showFloatingMessage("×”×¦×™×•×Ÿ ×•×”××©×•×‘ ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!", "success");
      
      // ××¨×¢× ×Ÿ ××ª ×”×˜×‘×œ×” ××—×¨×™ 1.5 ×©× ×™×™×”
      setTimeout(() => {
        loadSubs(aid, state.assignName);
      }, 1500);
      
    } catch (e) {
      console.error("Error updating grade:", e);
      showFloatingMessage("×¢×“×›×•×Ÿ × ×›×©×œ: " + e.message, "error");
    }
  }

  function showFloatingMessage(text, type = "success") {
    // ×”×¡×¨ ×”×•×“×¢×” ×§×™×™××ª
    const existing = document.querySelector('.floating-message');
    if (existing) existing.remove();
    
    // ×¦×•×¨ ×”×•×“×¢×” ×—×“×©×”
    const msg = document.createElement('div');
    msg.className = `floating-message ${type === 'error' ? 'error' : ''}`;
    msg.textContent = text;
    document.body.appendChild(msg);
    
    // ×”×¦×’
    setTimeout(() => msg.classList.add('show'), 100);
    
    // ×”×¡×ª×¨ ××—×¨×™ 3 ×©× ×™×•×ª
    setTimeout(() => {
      msg.classList.remove('show');
      setTimeout(() => msg.remove(), 300);
    }, 3000);
  }
</script>
</body>
</html>
