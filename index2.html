<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      margin: 0; padding: 0;
      background: #f4f6f9; color: #222;
      direction: rtl;
    }
    header {
      background: #004080; color: #fff;
      padding: 20px; text-align: center;
    }
    header h1 { margin: 0; font-size: 1.8em; }
    .container { max-width: 1100px; margin: auto; padding: 20px; }
    .tabs { margin-bottom: 20px; text-align: center; }
    .tabs button {
      margin: 0 5px; padding: 10px 20px;
      border: none; border-radius: 20px;
      background: #eee; cursor: pointer;
      font-weight: bold;
    }
    .tabs button.active { background: #004080; color: #fff; }
    button {
      cursor: pointer; border: none; border-radius: 6px;
      background: #0066cc; color: #fff;
      padding: 6px 12px; margin: 4px;
      font-size: 0.9em;
    }
    button:hover { background: #004d99; }
    table {
      border-collapse: collapse; width: 100%; margin: 15px 0;
      background: #fff; box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd; padding: 8px; text-align: right;
    }
    th { background: #f0f3f7; font-weight: bold; }
    .section { margin-bottom: 20px; }
    .hidden { display: none; }
    footer {
      margin-top: 40px; padding: 15px;
      text-align: center; font-size: 0.9em; color: #555;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <header>
    <h1>××›×œ×œ×ª ×ª×œ×¤×™×•×ª - ×©×œ×™×¤×ª ××™×“×¢ ××”××•×•×“×œ</h1>
  </header>

  <div class="container">
    <!-- ××¡×š ×›× ×™×¡×” -->
    <div id="loginScreen">
      <h2>×”×ª×—×‘×¨×•×ª ×¢× Token</h2>
      <p>×”×›× ×¡ ××ª ×”-Token ×©×œ×š ×›×“×™ ×œ×”×ª×—×‘×¨ ×œ×××©×§:</p>
      <input type="password" id="tokenInput" size="60" placeholder="×”×›× ×¡ ×›××Ÿ ××ª ×”-Token"><br><br>
      <button onclick="saveToken()">×©××•×¨ ×•×”×ª×—×‘×¨</button>
    </div>

    <!-- ××¡×š ×¨××©×™ -->
    <div id="mainScreen" class="hidden">
      <div class="tabs">
        <button id="tabHierarchyBtn" onclick="showTab('hierarchy')" class="active">ğŸ“š ×××©×§ ×”×™×¨×¨×›×™</button>
        <button id="tabFunctionsBtn" onclick="showTab('functions')">âš™ï¸ ×¤×•× ×§×¦×™×•×ª ×–××™× ×•×ª</button>
        <button onclick="deleteToken()">ğŸ—‘ï¸ ××—×§ Token</button>
      </div>

      <!-- ×”×™×¨×¨×›×™×” -->
      <div id="hierarchyTab" class="tab">
        <div id="years" class="section"></div>
        <div id="semesters" class="section"></div>
        <div id="courses" class="section"></div>
        <div id="assignments" class="section"></div>
        <div id="submissions" class="section"></div>
      </div>

      <!-- ×¤×•× ×§×¦×™×•×ª -->
      <div id="functionsTab" class="tab hidden">
        <h2>×›×œ ×”×¤×•× ×§×¦×™×•×ª ×”×–××™× ×•×ª</h2>
        <div id="functions" class="section"></div>
        <pre id="result"></pre>
      </div>
    </div>
  </div>

  <footer>
    ×¤×•×ª×— ×¢"×™ ×“"×¨ × ×™×¦×Ÿ ××œ×™×§×™× | ×¡×‘×™×‘×ª Vibe Coding
  </footer>

<script>
  const baseUrl = "https://moodle4.talpiot.ac.il";
  let token = localStorage.getItem("moodleToken") || "";

  const loginScreen = document.getElementById("loginScreen");
  const mainScreen = document.getElementById("mainScreen");

  window.onload = () => { if (token) init(); };

  function saveToken() {
    token = document.getElementById("tokenInput").value.trim();
    if (!token) { alert("× × ×œ×”×–×™×Ÿ Token"); return; }
    localStorage.setItem("moodleToken", token);
    init();
  }

  function deleteToken() {
    localStorage.removeItem("moodleToken");
    location.reload();
  }

  function showTab(tab) {
    document.getElementById("hierarchyTab").classList.add("hidden");
    document.getElementById("functionsTab").classList.add("hidden");
    document.getElementById("tabHierarchyBtn").classList.remove("active");
    document.getElementById("tabFunctionsBtn").classList.remove("active");
    if (tab === "hierarchy") {
      document.getElementById("hierarchyTab").classList.remove("hidden");
      document.getElementById("tabHierarchyBtn").classList.add("active");
    }
    if (tab === "functions") {
      document.getElementById("functionsTab").classList.remove("hidden");
      document.getElementById("tabFunctionsBtn").classList.add("active");
    }
  }

  async function apiCall(func, params={}) {
    const q = new URLSearchParams({ wstoken: token, wsfunction: func, moodlewsrestformat:"json" });
    for (const [k,v] of Object.entries(params)) q.append(k,v);
    const res = await fetch(`${baseUrl}/webservice/rest/server.php?${q}`);
    return await res.json();
  }

  async function init() {
    loginScreen.classList.add("hidden");
    mainScreen.classList.remove("hidden");
    await loadFunctions();
    await loadCourses();
  }

  // --- ×¤×•× ×§×¦×™×•×ª ---
  async function loadFunctions() {
    const info = await apiCall("core_webservice_get_site_info");
    const funcs = info.functions || [];
    const div = document.getElementById("functions");
    div.innerHTML = "";
    funcs.forEach(f => {
      const btn = document.createElement("button");
      btn.textContent = f.name;
      btn.onclick = async () => {
        const data = await apiCall(f.name);
        document.getElementById("result").textContent = JSON.stringify(data,null,2);
      };
      div.appendChild(btn);
    });
  }

  // --- ×”×™×¨×¨×›×™×” ---
  async function loadCourses() {
    const info = await apiCall("core_webservice_get_site_info");
    const courses = await apiCall("core_enrol_get_users_courses", { userid: info.userid });
    const yearsDiv = document.getElementById("years");
    yearsDiv.innerHTML = "<h3>×©× ×•×ª ×œ×™××•×“</h3>";
    const years = {};
    courses.forEach(c => {
      const year = (c.fullname.match(/20\\d{2}/)||["×œ× ×™×“×•×¢"])[0];
      if (!years[year]) years[year]=[];
      years[year].push(c);
    });
    Object.keys(years).forEach(y=>{
      const btn=document.createElement("button");
      btn.textContent=y;
      btn.onclick=()=>showSemesters(years[y]);
      yearsDiv.appendChild(btn);
    });
  }

  function showSemesters(courses) {
    const semDiv=document.getElementById("semesters");
    semDiv.innerHTML="<h3>×¡××¡×˜×¨×™×</h3>";
    document.getElementById("courses").innerHTML="";
    const sems={};
    courses.forEach(c=>{
      const sem=(c.fullname.match(/×¡××¡×˜×¨.?[××‘]/)||["×œ× ××•×’×“×¨"])[0];
      if(!sems[sem]) sems[sem]=[];
      sems[sem].push(c);
    });
    Object.keys(sems).forEach(s=>{
      const btn=document.createElement("button");
      btn.textContent=s;
      btn.onclick=()=>showCourses(sems[s]);
      semDiv.appendChild(btn);
    });
  }

  function showCourses(courses) {
    const div=document.getElementById("courses");
    div.innerHTML="<h3>×§×•×¨×¡×™×</h3>";
    courses.forEach(c=>{
      const btn=document.createElement("button");
      btn.textContent=c.fullname;
      btn.onclick=()=>loadAssignments(c.id);
      div.appendChild(btn);
    });
  }

  async function loadAssignments(courseid) {
    const data=await apiCall("mod_assign_get_assignments", {"courseids[0]":courseid});
    const assigns=(data.courses && data.courses[0])?data.courses[0].assignments:[];
    const div=document.getElementById("assignments");
    div.innerHTML="<h3>××˜×œ×•×ª</h3>";
    if (assigns.length===0) { div.innerHTML+="<p>××™×Ÿ ××˜×œ×•×ª ×‘×§×•×¨×¡ ×–×”</p>"; return; }
    let html="<table><tr><th>×©× ××˜×œ×”</th><th>×¤×ª×™×—×”</th><th>×“×“×œ×™×™×Ÿ</th></tr>";
    assigns.forEach(a=>{
      html+=`<tr>
        <td><button onclick="loadSubmissions(${a.id})">${a.name}</button></td>
        <td>${a.allowsubmissionsfromdate ? new Date(a.allowsubmissionsfromdate*1000).toLocaleString() : "-"}</td>
        <td>${a.duedate ? new Date(a.duedate*1000).toLocaleString() : "-"}</td>
      </tr>`;
    });
    html+="</table>";
    div.innerHTML+=html;
  }

  async function loadSubmissions(assignid) {
    const subsData=await apiCall("mod_assign_get_submissions", {"assignmentids[0]":assignid});
    const subs=(subsData.assignments && subsData.assignments[0])?subsData.assignments[0].submissions:[];
    const gradesData=await apiCall("mod_assign_get_grades", {"assignmentids[0]":assignid});
    const grades=(gradesData.assignments && gradesData.assignments[0])?gradesData.assignments[0].grades:[];
    const gradesMap={}; grades.forEach(g=>gradesMap[g.userid]=g.grade);

    const div=document.getElementById("submissions");
    div.innerHTML="<h3>×”×’×©×•×ª</h3>";
    if (subs.length===0) { div.innerHTML+="<p>××™×Ÿ ×”×’×©×•×ª</p>"; return; }

    let html="<table><tr><th>×¡×˜×•×“× ×˜</th><th>×§×‘×¦×™×</th><th>×¦×™×•×Ÿ</th></tr>";
    subs.forEach(s=>{
      let files=[];
      (s.plugins||[]).forEach(p=>{
        (p.fileareas||[]).forEach(fa=>{
          (fa.files||[]).forEach(file=>{
            const url=file.fileurl+"&token="+token;
            files.push(`<a href='${url}' target='_blank'>${file.filename}</a>`);
          });
        });
      });
      html+=`<tr>
        <td>${s.userid}</td>
        <td>${files.join("<br>") || "-"}</td>
        <td>${gradesMap[s.userid] ?? "-"}</td>
      </tr>`;
    });
    html+="</table>";
    div.innerHTML+=html;
  }
</script>
</body>
</html>
